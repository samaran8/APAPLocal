* @ValidationCode : MjotNTkxNjE5NTIzOkNwMTI1MjoxNjgxMTEwMjM2MTIxOklUU1M6LTE6LTE6MDowOmZhbHNlOk4vQTpSMjFfQU1SLjA6LTE6LTE=
* @ValidationInfo : Timestamp         : 10 Apr 2023 12:33:56
* @ValidationInfo : Encoding          : Cp1252
* @ValidationInfo : User Name         : ITSS
* @ValidationInfo : Nb tests success  : N/A
* @ValidationInfo : Nb tests failure  : N/A
* @ValidationInfo : Rating            : N/A
* @ValidationInfo : Coverage          : N/A
* @ValidationInfo : Strict flag       : N/A
* @ValidationInfo : Bypass GateKeeper : false
* @ValidationInfo : Compiler Version  : R21_AMR.0
* @ValidationInfo : Copyright Temenos Headquarters SA 1993-2021. All rights reserved.
$PACKAGE APAP.REDOBATCH
SUBROUTINE REDO.B.CREATE.RENEWAL(Y.CR.SEL.LIST)
********************************************************
* COMPANY NAME: ASOCIACION POPULAR DE AHORROS Y PRESTAMOS
* DEVELOPED BY: Swaminathan.S.R
* PROGRAM NAME: REDO.B.CREATE.RENEWAL
*------------------------------------------------------------------------------
*DESCRIPTION:This routine is COB routine to block previous card number and take new card number
*from REDO.CARD.RENEWAL and update the LATAM.CARD.ORDER
*-------------------------------------------------------------------------------
*-----------------------
* Modification History :
*-----------------------
*DATE             WHO                    REFERENCE            DESCRIPTION
*12-08-2010    Swaminathan.S.R        ODR-2010-03-0400      INITIAL CREATION
*27 MAY 2011   KAVITHA                PACS00063156           PACS00063156 FIX
*10 JUN 2011   KAVITHA                PACS00063138           FIX FOR PACS00063138
* Date                   who                   Reference              
* 10-04-2023         CONVERSTION TOOL     R22 AUTO CONVERSTION VM TO @VM AND FM TO @FM AND ++ TO += 1 AND = TO EQ
* 10-04-2023          ANIL KUMAR B        R22 MANUAL CONVERSTION -NO CHANGES
*-------------------------------------------------------------------------------
    $INSERT I_COMMON
    $INSERT I_EQUATE
    $INSERT I_BATCH.FILES
    $INSERT I_F.DATES
    $INSERT I_GTS.COMMON
    $INSERT I_REDO.B.CREATE.RENEWAL.COMMON
    $INSERT I_F.REDO.CARD.RENEWAL
    $INSERT I_F.LATAM.CARD.ORDER
    $INSERT I_F.HOLIDAY


*PACS00063156 -S

    Y.MSG = ''
    GOSUB PROCESS
RETURN

*----------
PROCESS:
*----------
    CALL F.READ(FN.REDO.CARD.RENEWAL,Y.CR.SEL.LIST,R.REDO.CARD.RENEWAL,F.REDO.CARD.RENEWAL,Y.ERR.RENEWAL)
    LOOP.CNTR = ''

    IF R.REDO.CARD.RENEWAL THEN
        Y.PREV.CARD.NO = R.REDO.CARD.RENEWAL<REDO.RENEW.PREV.CARD.NO>
        CHANGE @VM TO @FM IN Y.PREV.CARD.NO
        PREV.CNTR = DCOUNT(Y.PREV.CARD.NO,@FM)
        Y.EXPIRY.DATE = R.REDO.CARD.RENEWAL<REDO.RENEW.EXPIRY.DATE>
        Y.STATUS = R.REDO.CARD.RENEWAL<REDO.RENEW.STATUS>
        Y.AUTO.REN.FLAG =  R.REDO.CARD.RENEWAL<REDO.RENEW.AUTO.RENEW>
        ISSUE.TYPE = R.REDO.CARD.RENEWAL<REDO.RENEW.ISSUE.TYPE>
    END

    CHANGE @VM TO @FM IN Y.STATUS
    CHANGE @VM TO @FM IN Y.EXPIRY.DATE
    CHANGE @VM TO @FM IN Y.AUTO.REN.FLAG
    CHANGE @VM TO @FM IN ISSUE.TYPE

    LOOP.CNTR = 1
    LOOP
    WHILE LOOP.CNTR LE PREV.CNTR
        FETCH.PREV.CARD.NO = Y.PREV.CARD.NO<LOOP.CNTR>
        FETCH.EXP.DATE = Y.EXPIRY.DATE<LOOP.CNTR>
        FETCH.STATUS = Y.STATUS<LOOP.CNTR>
        FETCH.RENEW.FLAG = Y.AUTO.REN.FLAG<LOOP.CNTR>
        FETCH.ISSUE.TYPE = ISSUE.TYPE<LOOP.CNTR>

        FETCH.LWD = R.DATES(EB.DAT.LAST.WORKING.DAY)

        IF (FETCH.EXP.DATE EQ FETCH.LWD) AND (FETCH.STATUS NE 97) THEN

            Y.NEW.CARD = FIELD(FETCH.PREV.CARD.NO,".",1,1)
            Y.NEXT.CARD.NO = Y.NEW.CARD:".NEW"
            GOSUB BLOCK.CARD.NO

        END ELSE

            GOSUB HOLIDAY.EXP.CARD
        END

        Y.NEW.CARD = ''
        Y.NEXT.CARD.NO = ''
        FETCH.PREV.CARD.NO = ''
        FETCH.EXP.DATE = ''
        FETCH.STATUS = ''
        FETCH.RENEW.FLAG = ''
        FETCH.ISSUE.TYPE = ''

        LOOP.CNTR += 1

    REPEAT

RETURN
*----------------------------------------------------------------------------------------
HOLIDAY.EXP.CARD:


    CURRENT.MONTH = FETCH.EXP.DATE[5,2]

    BEGIN CASE

        CASE CURRENT.MONTH EQ 01
            FETCH.MONTH.HOLIDAY = R.HOLIDAY<EB.HOL.MTH.01.TABLE>

        CASE CURRENT.MONTH EQ 02
            FETCH.MONTH.HOLIDAY = R.HOLIDAY<EB.HOL.MTH.02.TABLE>

        CASE CURRENT.MONTH EQ 03
            FETCH.MONTH.HOLIDAY = R.HOLIDAY<EB.HOL.MTH.03.TABLE>

        CASE CURRENT.MONTH EQ 04
            FETCH.MONTH.HOLIDAY = R.HOLIDAY<EB.HOL.MTH.04.TABLE>

        CASE CURRENT.MONTH EQ 05
            FETCH.MONTH.HOLIDAY = R.HOLIDAY<EB.HOL.MTH.05.TABLE>

        CASE CURRENT.MONTH EQ 06
            FETCH.MONTH.HOLIDAY = R.HOLIDAY<EB.HOL.MTH.06.TABLE>

        CASE CURRENT.MONTH EQ 07
            FETCH.MONTH.HOLIDAY = R.HOLIDAY<EB.HOL.MTH.07.TABLE>

        CASE CURRENT.MONTH EQ 08
            FETCH.MONTH.HOLIDAY = R.HOLIDAY<EB.HOL.MTH.08.TABLE>

        CASE CURRENT.MONTH EQ 09
            FETCH.MONTH.HOLIDAY = R.HOLIDAY<EB.HOL.MTH.09.TABLE>

        CASE CURRENT.MONTH EQ 10
            FETCH.MONTH.HOLIDAY = R.HOLIDAY<EB.HOL.MTH.10.TABLE>

        CASE CURRENT.MONTH EQ 11
            FETCH.MONTH.HOLIDAY = R.HOLIDAY<EB.HOL.MTH.11.TABLE>

        CASE CURRENT.MONTH EQ 12
            FETCH.MONTH.HOLIDAY = R.HOLIDAY<EB.HOL.MTH.12.TABLE>

    END CASE

    CURRENT.DATE = FETCH.EXP.DATE[7,2]
    DATE.HOLIDAY = FETCH.MONTH.HOLIDAY[CURRENT.DATE,1]
    IF DATE.HOLIDAY EQ "H" AND FETCH.EXP.DATE LT FETCH.LWD THEN
        IF FETCH.STATUS NE 97 THEN
            Y.NEW.CARD = FIELD(FETCH.PREV.CARD.NO,".",1,1)
            Y.NEXT.CARD.NO = Y.NEW.CARD:".NEW"
            GOSUB BLOCK.CARD.NO
        END
    END
RETURN

*-----------
BLOCK.CARD.NO:
*-----------
*PACS00063138-S
    CALL F.READ(FN.LATAM.CARD.ORDER,FETCH.PREV.CARD.NO,R.LATAM.CARD.ORDER.PREV,F.LATAM.CARD.ORDER,Y.ERR.LCO.P)
    CO.CODE = ''
    Y.RECORD = ''

    IF R.LATAM.CARD.ORDER.PREV THEN
        CO.CODE = R.LATAM.CARD.ORDER.PREV<CARD.IS.CO.CODE>
    END

    Y.RECORD<CARD.IS.CARD.STATUS> = '97'

    Y.TRANSACTION.ID = FETCH.PREV.CARD.NO
    GOSUB POST.MSG.OFS
*PACS00063138-E

RETURN

*---------------
POST.MSG.OFS:
*-------------
    Y.OFSVERSION = "LATAM.CARD.ORDER,PRINCIPAL"
    Y.APP.NAME =  "LATAM.CARD.ORDER"
    Y.OFSFUNCT = 'I'
    Y.PROCESS = "PROCESS"
    Y.GTSMODE = ""
    Y.NO.OF.AUTH = "0"
    OFSRECORD = ""

    CALL OFS.BUILD.RECORD(Y.APP.NAME,Y.OFSFUNCT,Y.PROCESS,Y.OFSVERSION,Y.GTSMODE,Y.NO.OF.AUTH,Y.TRANSACTION.ID,Y.RECORD,OFSRECORD)

    Y.MSG = OFSRECORD
    Y.MSG.KEY = ""
    Y.OFS.SOURCE.ID = "DEBIT.CARD"
    Y.OPTIONS = ""

    CALL OFS.POST.MESSAGE(Y.MSG,Y.MSG.KEY,Y.OFS.SOURCE.ID,Y.OPTIONS)
RETURN

*PACS00063156 -E
END
