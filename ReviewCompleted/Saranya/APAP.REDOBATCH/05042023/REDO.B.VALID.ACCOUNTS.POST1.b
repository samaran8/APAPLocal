* @ValidationCode : MjotMTY0Njc1MzkwOkNwMTI1MjoxNjgwNzkwMTEwMzg0OklUU1M6LTE6LTE6ODg2OjE6ZmFsc2U6Ti9BOlIyMV9BTVIuMDotMTotMQ==
* @ValidationInfo : Timestamp         : 06 Apr 2023 19:38:30
* @ValidationInfo : Encoding          : Cp1252
* @ValidationInfo : User Name         : ITSS
* @ValidationInfo : Nb tests success  : N/A
* @ValidationInfo : Nb tests failure  : N/A
* @ValidationInfo : Rating            : 886
* @ValidationInfo : Coverage          : N/A
* @ValidationInfo : Strict flag       : true
* @ValidationInfo : Bypass GateKeeper : false
* @ValidationInfo : Compiler Version  : R21_AMR.0
* @ValidationInfo : Copyright Temenos Headquarters SA 1993-2021. All rights reserved.
$PACKAGE APAP.REDOBATCH
SUBROUTINE REDO.B.VALID.ACCOUNTS.POST1

*-----------------------------------------------------------------------------
*MODIFICATION HISTORY:
*
* DATE              WHO                REFERENCE                 DESCRIPTION
* 04-APR-2023     Conversion tool    R22 Auto conversion       No changes
* 04-APR-2023      Harishvikram C   Manual R22 conversion      CALL routine format modified
*-----------------------------------------------------------------------------
    $INSERT I_COMMON
    $INSERT I_EQUATE
    $INSERT I_F.ACCOUNT
    $INSERT I_F.CUSTOMER
    $INSERT I_BATCH.FILES
    $INSERT I_F.REDO.APAP.H.PARAMETER
    $INSERT I_F.REDO.ACCT.STATUS.CODE


    $INSERT I_F.REDO.INTERFACE.PARAM
    $INSERT I_F.REDO.INTERFACE.ACT
    $INSERT I_F.REDO.INTERFACE.ACT.DETAILS
    $INSERT I_F.REDO.INTERFACE.NOTIFY
    $INSERT I_F.REDO.INTERFACE.MON.TYPE
    $INSERT I_F.REDO.INTERFACE.SMAIL
    $INSERT I_F.LOCKING


    FN.REDO.APAP.H.PARAMETER = 'F.REDO.APAP.H.PARAMETER'
    F.REDO.APAP.H.PARAMETER = ''
    CALL OPF(FN.REDO.APAP.H.PARAMETER,F.REDO.APAP.H.PARAMETER)

    CALL CACHE.READ(FN.REDO.APAP.H.PARAMETER,"SYSTEM",R.REDO.APAP.H.PARAMETER,PARAM.ERR)
    IF PARAM.ERR EQ '' THEN
        CCY.FILE.NAME = R.REDO.APAP.H.PARAMETER<PARAM.APERTA.FILE.NAME>
        CCY.OUT.PATH = R.REDO.APAP.H.PARAMETER<PARAM.APERTA.PATH,1>
        CCY.OUT.PATH.OUT = R.REDO.APAP.H.PARAMETER<PARAM.APERTA.PATH,2>
    END

    FN.FILE.PATH=CCY.OUT.PATH

    OPEN CCY.OUT.PATH TO F.CCY.OUT.PATH ELSE

        OPEN.ERR= 'Unable to Open ':CCY.OUT.PATH.OUT
        GOSUB C22.LOG
        RETURN
    END

    OPEN CCY.OUT.PATH.OUT TO F.FILE.PAT.OUT ELSE

        OPEN.ERR= 'Unable to Open ':CCY.OUT.PATH.OUT
        GOSUB C22.LOG
        RETURN
    END

    Y.FINAL.ARRAY = ''
    Y.FILE.PATH = ''
    Y.FILE.NAME = ''

    GET.FILE.NAME1 = FIELD(CCY.FILE.NAME,'.',1)
    GET.FILE.NAME2 = FIELD(CCY.FILE.NAME,'.',2)

    PYMNT.FILE = TODAY:GET.FILE.NAME1:".":GET.FILE.NAME2
    GOSUB WRITE.IN.OUT.FILE

    SHELL.CMD ='SH -c '
    OLD.OUT.FILES = PYMNT.FILE:'_*'
    EXE.RM.CMD.IN="rm ":CCY.OUT.PATH:"/":PYMNT.FILE
    EXE.RM.CMD.OT="rm ":CCY.OUT.PATH.OUT:"/":PYMNT.FILE
    EXE.CAT.IN = "cat ":FN.FILE.PATH:"/":PAYMENT.IN.HEAD:" ":FN.FILE.PATH:"/":OLD.OUT.FILES:" >> ":CCY.OUT.PATH:"/":PYMNT.FILE
    EXE.CAT.OUT = "cat ":FN.FILE.PATH:"/":PAYMENT.OUT.HEAD:" ":FN.FILE.PATH:"/":OLD.OUT.FILES:" >> ":CCY.OUT.PATH.OUT:"/":PYMNT.FILE
    EXE.RM.CMD="rm ":FN.FILE.PATH:"/":OLD.OUT.FILES
    EXE.RMH.CMD="rm ":FN.FILE.PATH:"/":'HEAD*'
    DAEMON.CMD.IN = SHELL.CMD:EXE.CAT.IN
    DAEMON.CMD.OUT = SHELL.CMD:EXE.CAT.OUT
    DAEMON.REM.CMD = SHELL.CMD:EXE.RM.CMD
    DAEMON.RHM.CMD = SHELL.CMD:EXE.RMH.CMD
    DAEMON.RM.CMD.IN=SHELL.CMD:EXE.RM.CMD.IN
    DAEMON.RM.CMD.OT=SHELL.CMD:EXE.RM.CMD.OT

    EXECUTE DAEMON.RM.CMD.IN RETURNING RETURN.VALUE CAPTURING CAPTURE.CAT.VALUE
    EXECUTE DAEMON.RM.CMD.OT RETURNING RETURN.VALUE CAPTURING CAPTURE.CAT.VALUE
    EXECUTE DAEMON.CMD.IN RETURNING RETURN.VALUE CAPTURING CAPTURE.CAT.VALUE
    EXECUTE DAEMON.CMD.OUT RETURNING RETURN.VALUE CAPTURING CAPTURE.CAT.VALUE
    EXECUTE DAEMON.REM.CMD RETURNING RETURN.VALUE CAPTURING CAPTURE.REM.VALUE
    EXECUTE DAEMON.RHM.CMD RETURNING RETURN.VALUE CAPTURING CAPTURE.REM.VALUE
RETURN

WRITE.IN.OUT.FILE:

    PAYMENT.IN.HEAD='HEAD.IN'
    OPENSEQ FN.FILE.PATH,PAYMENT.IN.HEAD TO F.FILE.HEAD.IN ELSE
        CREATE F.FILE.HEAD.IN ELSE
            OPEN.ERR = 'Unable to Open / Create ':CCY.OUT.PATH:" " PYMNT.FILE
            GOSUB C22.LOG
            RETURN
        END
    END
    Y.IN.HEAD= 'UPDATEMATCH,DATE=':TODAY:',TABLE=CuentasValidas,WORKSOURCE=20'

    WRITESEQ Y.IN.HEAD APPEND TO F.FILE.HEAD.IN ELSE
        OPEN.ERR = 'Unable to Write ':CCY.OUT.PATH:" ":PYMNT.FILE
        GOSUB C22.LOG
        RETURN
    END

    PAYMENT.OUT.HEAD='HEAD.OUT'
    OPENSEQ FN.FILE.PATH,PAYMENT.OUT.HEAD TO F.FILE.HEAD.OUT ELSE
        CREATE F.FILE.HEAD.OUT ELSE
            OPEN.ERR = 'Unable to Open / Create ':CCY.OUT.PATH:" " PYMNT.FILE
            GOSUB C22.LOG
            RETURN
        END
    END
    Y.OUT.HEAD= 'UPDATEMATCH,DATE=':TODAY:',TABLE=CuentasValidas,WORKSOURCE=10'

    WRITESEQ Y.OUT.HEAD APPEND TO F.FILE.HEAD.OUT ELSE
        OPEN.ERR = 'Unable to Write ':CCY.OUT.PATH:" ":PYMNT.FILE
        GOSUB C22.LOG
        RETURN
    END

RETURN

*-------
C22.LOG:
*-------
    MON.TP = "04"
    REC.CON = OPEN.ERR
    DESC = 'ERROR IN COLLECTOR JOB'
    INT.CODE = 'APA001'
    INT.TYPE = 'BATCH'
    BAT.NO = ''
    BAT.TOT = ''
    INFO.OR = ''
    INFO.DE = ''
    ID.PROC = ''
    EX.USER = ''
    EX.PC = ''
    CALL APAP.REDOCHNLS.REDO.INTERFACE.REC.ACT(INT.CODE,INT.TYPE,BAT.NO,BAT.TOT,INFO.OR,INFO.DE,ID.PROC,MON.TP,DESC,REC.CON,EX.USER,EX.PC);*Manual R22 conversion
RETURN
END

*------------------
