$PACKAGE APAP.REDOENQ
SUBROUTINE REDO.E.NOF.CUS.EXPIRED.DOC.REPORT(Y.DATA)
*----------------------------------------------------------------------------
* COMPANY NAME: ASOCIACION POPULAR DE AHORROS Y PRESTAMOS
* DEVELOPED BY: JEYACHANDRAN S
* PROGRAM NAME: REDO.E.NOF.CUS.EXPIRED.DOC.REPORT
* ODR NO      : ODR-2010-03-0128
*----------------------------------------------------------------------
* DESCRIPTION  :This nofile enquiry routine is used to retrieve the customer's Id Expiration List from multiple files
* IN PARAMETER :NA
* OUT PARAMETER:ENQ.DATA
* LINKED WITH  :Enq REDO.CUS.EXPIRED.DOC.REPORT
* LINKED FILE  :DEPT.ACCT.OFFICER In Read Mode
*               CUST.DOCUMENT In Read Mode
*               DOCUMENT.TYPE In Read Mode
*               DOCUMENT.STATUS In Read Mode
*               USER Read Mode
*               CUSTOMER Read Mode
*----------------------------------------------------------------------
* Modification History :
*-----------------------
* DATE             WHO                 REFERENCE           DESCRIPTION
* 08.09.2010   Jeyachandran S        ODR-2010-03-0128    INITIAL CREATION
* 12-APRIL-2023      Harsha                R22 Auto Conversion  - F.READ to CACHE.READ , FM to @FM , SM to @SM and VM to @VM
* 12-APRIL-2023      Harsha                R22 Manual Conversion - No changes 
*-------------------------------------------------------------------------------------

    $INSERT I_COMMON
    $INSERT I_EQUATE
    $INSERT I_ENQUIRY.COMMON
    $INSERT I_F.DOCUMENT.TYPE
    $INSERT I_F.USER
    $INSERT I_F.DOCUMENT.STATUS
    $INSERT I_F.CUSTOMER
    $INSERT I_F.CUST.DOCUMENT
    $INSERT I_F.DEPT.ACCT.OFFICER
*   $INSERT I_F.USER
    $INSERT I_F.CR.PROFILE

    GOSUB INITIALIZE.VARIABLE
    GOSUB OPEN.FILES
    GOSUB CHECK.VALUE

RETURN

***********
INITIALIZE.VARIABLE:
***********
    Y.TOT.CUST = 0
    Y.TOT.DOC1 = 0
    Y.DATE.FROM.VAL = ''
    Y.CLIENT.TYPE.VAL=''
    Y.DATE.TO.VAL =''
    Y.FLAG =''
    Y.FLAG2 =''
    Y.FLAG = ''
    CUS.APPLICATION = 'CUSTOMER'
    CUS.FIELDS = 'L.CU.TIPO.CL':@VM:'L.CU.CIDENT':@VM:'L.CU.RNC':@VM:'L.CU.ACTANAC':@VM:'L.CU.NOUNICO'
    CUS.POS = ''
    CALL MULTI.GET.LOC.REF(CUS.APPLICATION,CUS.FIELDS,CUS.POS)
    Y.L.CU.TIPO.CL.POS = CUS.POS <1,1>
    Y.L.CU.CIDENT.POS = CUS.POS<1,2>
    Y.L.CU.RNC.POS = CUS.POS<1,3>
    Y.L.CU.ACTANAC.POS = CUS.POS<1,4>
    Y.L.CU.NOUNICO.POS = CUS.POS<1,5>
RETURN
*******
OPEN.FILES:
*******

    FN.DOCUMENT.TYPE = 'F.DOCUMENT.TYPE'
    F.DOCUMENT.TYPE = ''
    CALL OPF(FN.DOCUMENT.TYPE,F.DOCUMENT.TYPE)

    FN.USER = 'F.USER'
    F.USER = ''
    CALL OPF(FN.USER,F.USER)

    FN.DOCUMENT.STATUS = 'F.DOCUMENT.STATUS'
    F.DOCUMENT.STATUS = ''
    CALL OPF(FN.DOCUMENT.STATUS,F.DOCUMENT.STATUS)

    FN.CUSTOMER = 'F.CUSTOMER'
    F.CUSTOMER = ''
    CALL OPF(FN.CUSTOMER,F.CUSTOMER)

    FN.CUST.DOCUMENT = 'F.CUST.DOCUMENT'
    F.CUST.DOCUMENT = ''
    CALL OPF(FN.CUST.DOCUMENT,F.CUST.DOCUMENT)

    FN.DEPT.ACCT.OFFICER = 'F.DEPT.ACCT.OFFICER'
    F.DEPT.ACCT.OFFICER = ''
    CALL OPF(FN.DEPT.ACCT.OFFICER,F.DEPT.ACCT.OFFICER)

    FN.USER = 'F.USER'
    F.USER = ''
    CALL OPF(FN.USER,F.USER)

    FN.CR.PROFILE = 'F.CR.PROFILE'
    F.CR.PROFILE = ''
    CALL OPF(FN.CR.PROFILE,F.CR.PROFILE)

    Y.USER = OPERATOR
RETURN

************
CHECK.VALUE:
************

    SEL.CMD.CUST.DOC = "SELECT ":FN.CUST.DOCUMENT:" WITH STATUS EQ 3 "
    SEL.CMD1 = SEL.CMD.CUST.DOC

    LOCATE "EXP.DATE.FROM" IN D.FIELDS<1> SETTING FROMDATE.POS THEN
        Y.DATE.FROM.VAL = D.RANGE.AND.VALUE<FROMDATE.POS>
    END

    LOCATE "EXP.DATE.TO" IN  D.FIELDS<1> SETTING TODATE.POS THEN
        Y.DATE.TO.VAL = D.RANGE.AND.VALUE<TODATE.POS>
    END

    LOCATE "CLIENT.ID" IN D.FIELDS<1> SETTING CLIENTID.POS THEN
        Y.CLIENT.ID.VAL = D.RANGE.AND.VALUE<CLIENTID.POS>
        SEL.CMD.CUST.DOC:=" AND APPLN.TXN.REF EQ ": Y.CLIENT.ID.VAL
    END ELSE
        Y.CLIENT.ID.VAL = " "
    END

    LOCATE "ACC.EXECUTIVE" IN D.FIELDS<1> SETTING ACCEXE.POS THEN
        Y.ACC.EXECUTIVE.VAL = D.RANGE.AND.VALUE<ACCEXE.POS>
    END

    LOCATE "AGENCY" IN D.FIELDS<1> SETTING AGENCY.POS THEN
        Y.AGENCY.VAL  = D.RANGE.AND.VALUE<AGENCY.POS>
    END

    LOCATE "CLIENT.TYPE" IN D.FIELDS<1> SETTING CLITYPE.POS THEN
        Y.CLIENT.TYPE.VAL  = D.RANGE.AND.VALUE<CLITYPE.POS>
        CHANGE @SM TO ' ' IN Y.CLIENT.TYPE.VAL
    END


    LOCATE "USER" IN D.FIELDS<1> SETTING USER.POS THEN
        Y.USER.VAL  = D.RANGE.AND.VALUE<USER.POS>
        Y.USER.OPR  = D.LOGICAL.OPERANDS<USER.POS>
        SEL.CMD.CUST.DOC:=" AND INPUTTER LIKE ...":Y.USER.VAL:"..."
    END ELSE
        Y.USER.VAL = ""
    END

    LOCATE "DOC.TYPE" IN D.FIELDS<1> SETTING DOCTYPE.POS THEN
        Y.TYPE.VAL  = D.RANGE.AND.VALUE<DOCTYPE.POS>
        Y.TYPE.OPR  = D.LOGICAL.OPERANDS<DOCTYPE.POS>
    END
    SEL.CMD.DOC.STATUS = "SELECT ":FN.DOCUMENT.STATUS:" WITH @ID EQ 3 "

    LOCATE "DOC.STATUS" IN D.FIELDS<1> SETTING DOCSTATUS.POS THEN
        Y.STATUS.VAL  = D.RANGE.AND.VALUE<DOCSTATUS.POS>
        Y.STATUS.OPR  = D.LOGICAL.OPERANDS<DOCSTATUS.POS>
        SEL.CMD.DOC.STATUS:=" AND DESCRIPTION EQ ":Y.STATUS.VAL
        CALL EB.READLIST(SEL.CMD.DOC.STATUS,SEL.LIST,'',NO.OF.REC,REC.ERR)
        CALL F.READ(FN.DOCUMENT.STATUS,SEL.LIST,R.DOCUMENT.STATUS,F.DOCUMENT.STATUS,F.ERR)
        Y.DOC.STATUS = R.DOCUMENT.STATUS<DOC.STAT.DESCRIPTION>
        Y.DOC.STATUS.DIS1 = FIELD(Y.DOC.STATUS,@VM,2)
        IF Y.DOC.STATUS.DIS1 THEN
            Y.DOC.STATUS.DIS = FIELD(Y.DOC.STATUS,@VM,2)
        END ELSE
            Y.FLAG4 = '1'
            GOSUB GOEND
        END

    END ELSE

        Y.STATUS.VAL=''
        SEL.CMD.DOC.STATUS = "SELECT ":FN.DOCUMENT.STATUS:" WITH @ID EQ 3 "
        CALL EB.READLIST(SEL.CMD.DOC.STATUS,SEL.LIST,'',NO.OF.REC,REC.ERR)
        CALL F.READ(FN.DOCUMENT.STATUS,SEL.LIST,R.DOCUMENT.STATUS,F.DOCUMENT.STATUS,F.ERR)
        Y.DOC.STATUS = R.DOCUMENT.STATUS<DOC.STAT.DESCRIPTION>
        Y.DOC.STATUS.DIS = FIELD(Y.DOC.STATUS,@VM,2)
    END


************
CLIENT.TYPE:
************

    IF Y.CLIENT.TYPE.VAL NE "" THEN
        IF Y.CLIENT.TYPE.VAL NE "PERSONA FISICA" AND Y.CLIENT.TYPE.VAL NE "CLIENTE MENOR" AND Y.CLIENT.TYPE.VAL NE "PERSONA JURIDICA" THEN
            ENQ.ERROR = 'EB-INVALID.CLIENT.TYPE'
            CALL STORE.END.ERROR
            GOSUB GOEND
        END ELSE
            GOSUB PROCESS
        END
    END ELSE
        GOSUB PROCESS

    END
RETURN

*********
PROCESS:
*********

    IF SEL.CMD1 EQ SEL.CMD.CUST.DOC THEN
        SEL.CMD.CUST.DOC = "SELECT ":FN.CUST.DOCUMENT:" WITH STATUS EQ 3 "
    END

    Y.TYPE.VAL = D.RANGE.AND.VALUE<DOCTYPE.POS>
    Y.TYPE.OPR = D.LOGICAL.OPERANDS<DOCTYPE.POS>
    IF Y.TYPE.VAL NE "" THEN
        SEL.CMD.CUST.DOC:=" AND @ID LIKE ...":Y.TYPE.VAL
    END

    IF Y.DATE.FROM.VAL NE "" THEN
        SEL.CMD.CUST.DOC:= " AND END.DATE GE ": Y.DATE.FROM.VAL
    END

    IF Y.DATE.TO.VAL  NE "" THEN
        SEL.CMD.CUST.DOC:=" AND END.DATE LE ": Y.DATE.TO.VAL
    END

    CALL EB.READLIST(SEL.CMD.CUST.DOC,SEL.LIST.DOC,'',NO.OF.REC,ERR)
    LOOP
        REMOVE ID FROM SEL.LIST.DOC SETTING POS
    WHILE ID:POS
        CALL F.READ(FN.CUST.DOCUMENT,ID,R.CUST.DOCUMENT,F.CUST.DOCUMENT,F.ERR)
        Y.CUST.DOC = ID
        Y.INPUTTER.ID =R.CUST.DOCUMENT<CUS.DOC.INPUTTER>
        Y.INPUTTER = FIELD(Y.INPUTTER.ID,'_',2)
        Y.A.ID=R.CUST.DOCUMENT<CUS.DOC.APPLN.TXN.REF>

        IF Y.USER.VAL NE "" THEN
            IF Y.INPUTTER EQ Y.USER.VAL THEN
            END ELSE
                GOSUB CUST.END
            END
        END

        GOSUB CUST.DOCUMENT
        GOSUB CUSTOMER.FILE
        GOSUB ACCOFFICER.FILE
        GOSUB AGENCY.FILE
        GOSUB CLIENT.TYPE1
    REPEAT

    IF Y.DATA NE '' THEN
        Y.DATA<-1>= '*':'*':'Total Clientes :':'*':Y.TOT.CUST:'*':'*':'*':'*':'*':'Total De documentos :':Y.TOT.DOC1
    END
    GOSUB GOEND
RETURN

***************
CUST.DOCUMENT:
***************

    Y.COUNT1 = DCOUNT(R.CUST.DOCUMENT,@VM)
    Y.TOT.DOCS = Y.COUNT1+1

    Y.CUST.ID = FIELD(Y.CUST.DOC,'*',1)
    Y.CLIENT.ID.VAL = D.RANGE.AND.VALUE<CLIENTID.POS>
    IF Y.CLIENT.ID.VAL NE Y.CUST.ID THEN
        GOSUB CUST.END
    END

RETURN

***************
CUSTOMER.FILE:
***************

    CALL F.READ(FN.CUSTOMER,Y.CUST.ID,R.CUSTOMER,F.CUSTOMER,F.ERR)
    Y.ACC.EXECUTIVE.VAL = D.RANGE.AND.VALUE<ACCEXE.POS>
    IF Y.ACC.EXECUTIVE.VAL NE "" THEN
        ACCTOFFICER.ID = R.CUSTOMER<EB.CUS.ACCOUNT.OFFICER>
        IF ACCTOFFICER.ID EQ Y.ACC.EXECUTIVE.VAL THEN

        END ELSE
            GOSUB CUST.END
        END
    END
RETURN

****************
ACCOFFICER.FILE:
****************

    Y.AGENCY.VAL  = D.RANGE.AND.VALUE<AGENCY.POS>
    IF Y.AGENCY.VAL NE "" THEN
        IF ACCTOFFICER.ID EQ Y.AGENCY.VAL THEN

        END ELSE
            GOSUB CUST.END
        END
    END
RETURN

***************
AGENCY.FILE:
***************

    Y.CLIENT.TYPE.VAL  = D.RANGE.AND.VALUE<CLITYPE.POS>
    CHANGE @SM TO ' ' IN Y.CLIENT.TYPE.VAL
    IF Y.CLIENT.TYPE.VAL NE "" THEN
        Y.CUST.TYPE = R.CUSTOMER<EB.CUS.LOCAL.REF><1,Y.L.CU.TIPO.CL.POS>
        IF Y.CUST.TYPE EQ Y.CLIENT.TYPE.VAL THEN

        END ELSE
            GOSUB CUST.END
        END
    END
RETURN

**************
CLIENT.TYPE1:
**************

    Y.CUST.ID = Y.CUST.ID

    Y.CLIENTID = R.CUSTOMER<EB.CUS.LOCAL.REF,Y.L.CU.CIDENT.POS>

    IF Y.CLIENTID NE '' THEN
        Y.TYPE.OF.ID = "CEDULA"
    END

    Y.LEGALID = R.CUSTOMER<EB.CUS.LEGAL.ID>
    IF Y.LEGALID NE '' THEN
        Y.TYPE.OF.ID = "PASAPORTE"
    END

    Y.RNC = R.CUSTOMER<EB.CUS.LOCAL.REF,Y.L.CU.RNC.POS>
    IF Y.RNC NE '' THEN
        Y.TYPE.OF.ID = "RNC"
    END

    Y.ACT =  R.CUSTOMER<EB.CUS.LOCAL.REF,Y.L.CU.ACTANAC.POS>
    IF Y.ACT NE '' THEN
        Y.TYPE.OF.ID = "ACTA NACIMIENTO"
    END

    Y.MON = R.CUSTOMER<EB.CUS.LOCAL.REF,Y.L.CU.NOUNICO.POS>
    IF Y.MON  NE '' THEN
        Y.TYPE.OF.ID = "NUMERO UNICO"
    END

    IF Y.TYPE.OF.ID NE '' THEN
        Y.ID.NUMBER = Y.TYPE.OF.ID
    END


    Y.CUST.TYPE = R.CUSTOMER<EB.CUS.LOCAL.REF><1,Y.L.CU.TIPO.CL.POS>
    Y.CLIENT.SEGMENT.ID = R.CUSTOMER<EB.CUS.CR.PROFILE>

    CALL F.READ(FN.CR.PROFILE,Y.CLIENT.SEGMENT.ID,R.CR.PROFILE,F.CR.PROFILE,CR.PROFILE.ERR)
    Y.CLIENT.SEGMENT = R.CR.PROFILE<CR.PROFILE.DESC,LNGG>
    IF NOT(Y.CLIENT.SEGMENT) THEN
        Y.CLIENT.SEGMENT = R.CR.PROFILE<CR.PROFILE.DESC,1>
    END

    Y.OTHEROFF.ID = R.CUSTOMER<EB.CUS.OTHER.OFFICER>
    IF  Y.OTHEROFF.ID THEN
        CALL CACHE.READ(FN.DEPT.ACCT.OFFICER, Y.OTHEROFF.ID, R.DEPT.ACCT.OFFICER, F.ERR)	;*R22 Auto Conversion  - F.READ to CACHE.READ
        Y.OTHERNAME = R.DEPT.ACCT.OFFICER<EB.DAO.NAME>
        Y.AGENCY.DIS = Y.OTHERNAME
    END

    ACCTOFFICER.ID = R.CUSTOMER<EB.CUS.ACCOUNT.OFFICER>
    IF ACCTOFFICER.ID THEN
        CALL CACHE.READ(FN.DEPT.ACCT.OFFICER, ACCTOFFICER.ID, R.DEPT.ACCT.OFFICER, F.ERR)	;*R22 Auto Conversion  - F.READ to CACHE.READ
        Y.NAME = R.DEPT.ACCT.OFFICER<EB.DAO.NAME>
        Y.ACC.EXEC.DIS = Y.NAME
    END



    Y.EMAIL = R.CUSTOMER<EB.CUS.EMAIL.1>
    Y.DOC.TYPE.DISC = FIELD(Y.CUST.DOC,'*',2)
    IF Y.DOC.TYPE.DISC THEN
        CALL CACHE.READ(FN.DOCUMENT.TYPE, Y.DOC.TYPE.DISC, R.DOCUMENT.TYPE, F.ERR)
        Y.DOCTYPE = R.DOCUMENT.TYPE<DOC.TYP.DESCRIPTION>
        Y.DOC.TYPE.DIS = Y.DOCTYPE
    END



    Y.DOC.EXPIRE.DATE  = R.CUST.DOCUMENT<CUS.DOC.END.DATE>

    Y.DOC.STATUS.ID = R.CUST.DOCUMENT<CUS.DOC.STATUS>

    Y.A.ID=R.CUST.DOCUMENT<CUS.DOC.APPLN.TXN.REF>
    IF Y.ACC.EXECUTIVE.VAL NE '' THEN
        CALL F.READ(FN.CUSTOMER,Y.A.ID,R.CUSTOMER,F.CUSTOMER,F.ERR)
        Y.OFFICER = R.CUSTOMER<EB.CUS.ACCOUNT.OFFICER>
        IF Y.OFFICER NE Y.ACC.EXECUTIVE.VAL THEN
            Y.FLAG = '1'

        END
    END


    IF Y.AGENCY.VAL NE ''  THEN
        CALL F.READ(FN.CUSTOMER,Y.A.ID,R.CUSTOMER,F.CUSTOMER,F.ERR)
        Y.OHEROFFICER = R.CUSTOMER<EB.CUS.OTHER.OFFICER>
        IF Y.OHEROFFICER NE Y.AGENCY.VAL THEN
            Y.FLAG2 = '1'
        END
    END

    IF Y.CLIENT.TYPE.VAL NE '' THEN
        CALL F.READ(FN.CUSTOMER,Y.A.ID,R.CUSTOMER,F.CUSTOMER,F.ERR)
        Y.CLIENT.TYPE = R.CUSTOMER<EB.CUS.LOCAL.REF><1,Y.L.CU.TIPO.CL.POS>
        IF Y.CLIENT.TYPE NE Y.CLIENT.TYPE.VAL THEN
            Y.FLAG3 = '1'
        END
    END

    IF Y.FLAG NE '1' AND Y.FLAG2 NE '1' AND Y.FLAG3 NE '1' AND Y.FLAG4 NE '1' THEN
        Y.TOT.CUST += 1
        Y.TOT.DOC<-1> = Y.DOC.TYPE.DIS
        Y.TOT.DOC = CHANGE(Y.TOT.DOC,@FM,@VM)
        Y.TOT.DOC1 = DCOUNT(Y.TOT.DOC,@VM)
        Y.DATA<-1> = Y.CUST.ID:'*':Y.TYPE.OF.ID:'*':Y.ID.NUMBER:'*':Y.CUST.TYPE:'*':Y.CLIENT.SEGMENT:'*':Y.AGENCY.DIS:'*':Y.ACC.EXEC.DIS:'*':Y.EMAIL:'*':Y.DOC.TYPE.DIS:'*':Y.DOC.EXPIRE.DATE:'*':Y.DOC.STATUS.DIS
    END
    Y.FLAG = '';Y.FLAG2= '';Y.FLAG3 = '';Y.FLAG4 = ''

RETURN
**********
CUST.END:
**********
RETURN
*******
GOEND:
*******
END
