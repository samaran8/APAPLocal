*-----------------------------------------------------------------------------
* <Rating>193</Rating>
*-----------------------------------------------------------------------------
    SUBROUTINE REDO.E.NOF.NAB.INT.ACCT(ENQ.DATA)

* Description           : This routine is attached to the Enquiry 'REDO.NOFILE.NAB.INT.ACCT'
*
*
* Developed By          : Ashokkumar
*
*--------------------------------------------------------------------------------------------------
*  M O D I F I C A T I O N S
* ***************************
*--------------------------------------------------------------------------------------------------
* Defect Reference       Modified By                    Date of Change        Change Details
* (RTC/TUT/PACS)
*
*--------------------------------------------------------------------------------------------------

    $INCLUDE T24.BP I_COMMON
    $INCLUDE T24.BP I_EQUATE
    $INCLUDE T24.BP I_F.DATES
    $INCLUDE T24.BP I_F.ACCOUNT
    $INCLUDE T24.BP I_F.RE.STAT.REP.LINE
    $INCLUDE T24.BP I_F.EB.CONTRACT.BALANCES


    GOSUB INIT
    GOSUB GET.LOC
    GOSUB PROCESS
    ENQ.DATA = YARRY.VAL
    RETURN

INIT:
*****
    Y.REGULATORY.ACC.NO = ''; ENQ.DATA = ''
    AC.LEN = 7; L.OD.STATUS.POS = ''; YARRY.VAL = ''; REQUEST.TYPE = ''
    FN.ACCOUNT = 'F.ACCOUNT'; F.ACCOUNT = ''
    CALL OPF(FN.ACCOUNT,F.ACCOUNT)
    FN.RE.STAT.REP.LINE = 'F.RE.STAT.REP.LINE'; F.RE.STAT.REP.LINE = ''
    CALL OPF(FN.RE.STAT.REP.LINE,F.RE.STAT.REP.LINE)
    FN.EB.CONTRACT.BALANCES = 'F.EB.CONTRACT.BALANCES'; F.EB.CONTRACT.BALANCES = ''
    CALL OPF(FN.EB.CONTRACT.BALANCES,F.EB.CONTRACT.BALANCES)
    FN.REDO.CONCAT.ACC.NAB = 'F.REDO.CONCAT.ACC.NAB'; F.REDO.CONCAT.ACC.NAB = ''
    CALL OPF(FN.REDO.CONCAT.ACC.NAB,F.REDO.CONCAT.ACC.NAB)

    YLAST.DATE = R.DATES(EB.DAT.LAST.WORKING.DAY)
    Y.TODAY = TODAY
    YTODAY.DAT = Y.TODAY
    CALL CDT('',YTODAY.DAT,'-1C')
    IF YLAST.DATE[5,2] NE YTODAY.DAT[5,2] THEN
        COMI = YLAST.DATE[1,6]:'01'
        CALL LAST.DAY.OF.THIS.MONTH
        YTODAY.DAT = COMI
    END
    END.DATE = YTODAY.DAT
    RETURN

GET.LOC:
********
    Y.APP = "ACCOUNT"
    Y.FIELDS = "L.OD.STATUS"
    Y.FIELD.POS = ""
    CALL MULTI.GET.LOC.REF(Y.APP,Y.FIELDS,Y.FIELD.POS)
    L.OD.STATUS.POS = Y.FIELD.POS<1,1>
    RETURN

PROCESS:
********
    ERR.SEL = ''; SEL.AACCMD = ''; SEL.AALIST = ''; SEL.AACNT = ''
    SEL.AACCMD = "SELECT ":FN.REDO.CONCAT.ACC.NAB
    CALL EB.READLIST(SEL.AACCMD,SEL.AALST,'',SEL.AACNT,ERR.SEL)
    SEL.CNT = 1
    LOOP
    WHILE SEL.CNT LE SEL.AACNT
        ACCT.ID = ''; Y.REGULATORY.ACC.NO = ''
        ACCT.ID = SEL.AALST<SEL.CNT>
        ERR.ACCT = ''; R.ACCOUNT = ''; YNAB.STATUS = ''; START.DATE = ''; Y.ARRY.VAL = ''
        CALL F.READ(FN.ACCOUNT,ACCT.ID,R.ACCOUNT,F.ACCOUNT,ERR.ACCT)
        YNAB.STATUS = R.ACCOUNT<AC.LOCAL.REF,L.OD.STATUS.POS>
        START.DATE = R.ACCOUNT<AC.OPENING.DATE>
        GOSUB PROCESS.ECB
        IF YTMP.FLG EQ 1 THEN
            GOSUB PROCESS.NAB
        END
        SEL.CNT = SEL.CNT + 1
    REPEAT
    RETURN

PROCESS.ECB:
************
    R.EB.CON.BAL = ''; EB.CON.BAL.ERR = ''; SAVE.ACC.AC = ''; REGULATORY.ACC.GRP = ''
    YTMP.FLG = 0
    CALL F.READ(FN.EB.CONTRACT.BALANCES,ACCT.ID,R.EB.CON.BAL,F.EB.CONTRACT.BALANCES,EB.CON.BAL.ERR)
    IF NOT(R.EB.CON.BAL) THEN
        RETURN
    END
    Y.CONSOL.KEY = R.EB.CON.BAL<ECB.CONSOL.KEY>
    Y.CONSOL.PART = FIELD(Y.CONSOL.KEY,'.',1,16)
    Y.ASSET.TYPE = R.EB.CON.BAL<ECB.CURR.ASSET.TYPE>
    CTR.BAL.TYPE = 1
    CNT.BAL.TYPE = DCOUNT(Y.ASSET.TYPE,VM)
    LOOP
    WHILE CTR.BAL.TYPE LE CNT.BAL.TYPE
        ACC.POS = ''; Y.REGULATORY.ACC.NO = ''; Y.REGULATORY.ACC.SAP = ''
        BAL.TYPE1 = Y.ASSET.TYPE<1,CTR.BAL.TYPE>
        IF BAL.TYPE1[1,3] EQ 'UNC' THEN
            CTR.BAL.TYPE = CTR.BAL.TYPE + 1
            CONTINUE
        END
        LEN.TYPE = LEN(BAL.TYPE1)
        REQ.LEN = BAL.TYPE1[((LEN.TYPE-AC.LEN)+1),AC.LEN]
        IF (REQ.LEN EQ 'ACCOUNT') THEN
            LOCATE BAL.TYPE1 IN SAVE.ACC.AC<1> SETTING ACC.POS THEN
                CTR.BAL.TYPE = CTR.BAL.TYPE + 1
                CONTINUE
            END ELSE
                SAVE.ACC.AC<1> = BAL.TYPE1
            END
            Y.IN.CONSOL.KEY = Y.CONSOL.PART:'.':BAL.TYPE1
            Y.VARIABLE = ''; ERROR.MESSAGE = ''; BAL.DETAILS = ''; REQUEST.TYPE = ''; REQUEST.TYPE<4>='ECB'
            CALL RE.CALCUL.REP.AL.LINE(Y.IN.CONSOL.KEY,Y.RPRTS,Y.LINES,Y.VARIABLE)
            Y.LINE = Y.RPRTS:'.':Y.LINES
            CALL F.READ(FN.RE.STAT.REP.LINE,Y.LINE,R.LINE,F.RE.STAT.REP.LINE,REP.ERR)
            CALL AA.GET.PERIOD.BALANCES(ACCT.ID, BAL.TYPE1,REQUEST.TYPE, START.DATE, END.DATE, '',BAL.DETAILS, ERROR.MESSAGE)
            DAT.BALANCES = BAL.DETAILS<4>
            Y.REGULATORY.ACC.NO = R.LINE<RE.SRL.DESC,1>
            Y.REGULATORY.ACC.SAP = R.LINE<RE.SRL.DESC,3>
            IF Y.REGULATORY.ACC.NO[1,1] EQ '1' AND DAT.BALANCES NE 0 THEN
                GOSUB LINE.FORM
                REGULATORY.ACC.GRP<-1> = Y.REGULATORY.ACC.NO
                IF Y.REGULATORY.ACC.NO[1,3] EQ '123' THEN
                    YTMP.FLG = 1
                END
            END
        END
        CTR.BAL.TYPE = CTR.BAL.TYPE + 1
    REPEAT
    RETURN

LINE.FORM:
**********
    LOCATE Y.REGULATORY.ACC.NO IN REGULATORY.ACC.GRP<1> SETTING YFM THEN
        YGRPBAL = YARRY.VAL<YFM,5> + DAT.BALANCES
        Y.ARRY.VAL<YFM> = ACCT.ID:'**':Y.REGULATORY.ACC.NO:'*':Y.REGULATORY.ACC.SAP:'*':YGRPBAL
    END ELSE
        Y.ARRY.VAL<-1> = ACCT.ID:'**':Y.REGULATORY.ACC.NO:'*':Y.REGULATORY.ACC.SAP:'*':DAT.BALANCES
    END
    RETURN

PROCESS.NAB:
************
    ERR.REDO.CONCAT.ACC.NAB = ''; R.REDO.CONCAT.ACC.NAB = ''
    CALL F.READ(FN.REDO.CONCAT.ACC.NAB,ACCT.ID,R.REDO.CONCAT.ACC.NAB,F.REDO.CONCAT.ACC.NAB,ERR.REDO.CONCAT.ACC.NAB)
    IF ERR.REDO.CONCAT.ACC.NAB THEN
        IF YTMP.FLG EQ 1 THEN
            YARRY.VAL = Y.ARRY.VAL
        END
        RETURN
    END
    YSAP.ACC.NO = '';  BAL.TYPE1 = "OFFDB"; REQUEST.TYPE= ''; REQUEST.TYPE<4> = "ECB"
    BAL.DETAILS = 0; ERROR.MESSAGE = ''; YACC.NABBAL = ''; YGL.CODE.TMP = ''; YSAP.ACC.NO = ''; YCR.AMT = 0
    CALL AA.GET.PERIOD.BALANCES(R.REDO.CONCAT.ACC.NAB, BAL.TYPE1,REQUEST.TYPE, START.DATE, END.DATE, '',BAL.DETAILS, ERROR.MESSAGE)
    YCR.AMT = BAL.DETAILS<4>
    YGL.CODE.TMP = ''; R.EB.CONTRACT.BALANCES = ''; Y.IN.CONSOL.KEY = ''; EB.CONTRACT.BALANCES.ERR = ''
    CALL F.READ(FN.EB.CONTRACT.BALANCES,R.REDO.CONCAT.ACC.NAB,R.EB.CONTRACT.BALANCES,F.EB.CONTRACT.BALANCES,EB.CONTRACT.BALANCES.ERR)
    IF NOT(R.EB.CONTRACT.BALANCES) THEN
        IF YTMP.FLG EQ 1 THEN
            YARRY.VAL = Y.ARRY.VAL
        END
        RETURN
    END
    Y.CONSOL.KEY = R.EB.CONTRACT.BALANCES<ECB.CONSOL.KEY>
    Y.CONSOL.PART = FIELD(Y.CONSOL.KEY,'.',1,16)
    Y.IN.CONSOL.KEY = Y.CONSOL.PART:'.':BAL.TYPE1
    Y.VARIABLE = ''; Y.RPRTS = ''; Y.LINES = ''
    CALL RE.CALCUL.REP.AL.LINE(Y.IN.CONSOL.KEY,Y.RPRTS,Y.LINES,Y.VARIABLE)
    Y.LINE = Y.RPRTS:'.':Y.LINES
    CALL F.READ(FN.RE.STAT.REP.LINE,Y.LINE,R.LINE,F.RE.STAT.REP.LINE,REP.ERR)
    YGL.CODE.TMP = R.LINE<RE.SRL.DESC,1>
    YSAP.ACC.NO = R.LINE<RE.SRL.DESC,3>
    IF (YGL.CODE.TMP[1,6] NE '128.03' AND YTMP.FLG EQ 1) THEN
        IF YCR.AMT NE 0 THEN
            YARRY.VAL<-1> = Y.ARRY.VAL
            YARRY.VAL<-1> = ACCT.ID:'*':R.REDO.CONCAT.ACC.NAB:'*':YGL.CODE.TMP:'*':YSAP.ACC.NO:'*':YCR.AMT
        END
        YTMP.FLG = 0
    END
*    IF (YGL.CODE.TMP[1,6] EQ '128.03' AND YCR.AMT EQ 0 AND YTMP.FLG EQ 1) THEN
*        YARRY.VAL<-1> = Y.ARRY.VAL
*    END
    RETURN
END
