*-----------------------------------------------------------------------------
* <Rating>-42</Rating>
*-----------------------------------------------------------------------------
    SUBROUTINE REDO.AA.ADV.PAY.RPT
    $INCLUDE T24.BP I_COMMON
    $INCLUDE T24.BP I_EQUATE
    $INCLUDE T24.BP I_F.DATES
    $INCLUDE T24.BP I_BATCH.FILES
    $INCLUDE T24.BP I_F.AA.ARRANGEMENT.ACTIVITY
    $INCLUDE T24.BP I_F.AA.ACTIVITY.BALANCES
    $INCLUDE T24.BP I_F.AA.ARRANGEMENT
    $INCLUDE TAM.BP I_F.REDO.L.NCF.STOCK
    $INCLUDE TAM.BP I_F.REDO.H.REPORTS.PARAM

    GOSUB INIT
    GOSUB GET.PARAM
    GOSUB PROCESS
    RETURN

INIT:
*****
    FN.AA.ARRANGEMENT.ACTIVITY = 'F.AA.ARRANGEMENT.ACTIVITY'; F.AA.ARRANGEMENT.ACTIVITY = ''
    CALL OPF(FN.AA.ARRANGEMENT.ACTIVITY,F.AA.ARRANGEMENT.ACTIVITY)
    FN.AA.ACTIVITY.BALANCES = 'F.AA.ACTIVITY.BALANCES'; F.AA.ACTIVITY.BALANCES = ''
    CALL OPF(FN.AA.ACTIVITY.BALANCES,F.AA.ACTIVITY.BALANCES)
    FN.AA.ARRANGEMENT = 'F.AA.ARRANGEMENT'; F.AA.ARRANGEMENT = ''
    CALL OPF(FN.AA.ARRANGEMENT,F.AA.ARRANGEMENT)
    FN.REDO.L.NCF.STOCK = 'F.REDO.L.NCF.STOCK'; F.REDO.L.NCF.STOCK = ''
    CALL OPF(FN.REDO.L.NCF.STOCK,F.REDO.L.NCF.STOCK)
    FN.REDO.H.REPORTS.PARAM = 'F.REDO.H.REPORTS.PARAM'; F.REDO.H.REPORTS.PARAM = ''
    CALL OPF(FN.REDO.H.REPORTS.PARAM,F.REDO.H.REPORTS.PARAM)
    YEND.DATE = ''; YSTART.DATE = ''
    RETURN

GET.PARAM:
**********
    Y.LAST.WORK.DAY = R.DATES(EB.DAT.LAST.WORKING.DAY)
    REDO.L.NCF.STOCK.ERR = ''; R.REDO.L.NCF.STOCK = ''; YBALANC.TYP = ''
    CALL CACHE.READ(FN.REDO.L.NCF.STOCK,'SYSTEM',R.REDO.L.NCF.STOCK,REDO.L.NCF.STOCK.ERR)
    YBALANC.TYP = R.REDO.L.NCF.STOCK<ST.AA.IC.TYPE>
    Y.PARAM.ID = 'REDO.AA.ADVPAY'; R.REDO.H.REPORTS.PARAM = ''; Y.PARAM.ERR = ''
    CALL CACHE.READ(FN.REDO.H.REPORTS.PARAM,Y.PARAM.ID,R.REDO.H.REPORTS.PARAM,Y.PARAM.ERR)
    IF R.REDO.H.REPORTS.PARAM THEN
        FN.CHK.DIR = R.REDO.H.REPORTS.PARAM<REDO.REP.PARAM.OUT.DIR>
        Y.FILE.NAME = R.REDO.H.REPORTS.PARAM<REDO.REP.PARAM.OUT.FILE.NAME>
        Y.FIELD.NAME = R.REDO.H.REPORTS.PARAM<REDO.REP.PARAM.FIELD.NAME>
        Y.FIELD.VAL  = R.REDO.H.REPORTS.PARAM<REDO.REP.PARAM.FIELD.VALUE>
    END
    LOCATE 'FROM.DATE' IN Y.FIELD.NAME<1,1> SETTING Y.FRM.POS THEN
        YSTART.DATE = Y.FIELD.VAL<1,Y.FRM.POS>
    END
    LOCATE 'TO.DATE' IN Y.FIELD.NAME<1,1> SETTING Y.TO.POS THEN
        YEND.DATE = Y.FIELD.VAL<1,Y.TO.POS>
    END
    F.CHK.DIR = ''
    CALL OPF(FN.CHK.DIR,F.CHK.DIR)
    Y.FINAL.OUT.FILE.NAME = Y.FILE.NAME:TODAY:".txt"
    R.FIL = ''; READ.FIL.ERR = ''
    CALL F.READ(FN.CHK.DIR,Y.FINAL.OUT.FILE.NAME,R.FIL,F.CHK.DIR,READ.FIL.ERR)
    IF R.FIL THEN
        DELETE F.CHK.DIR,Y.FINAL.OUT.FILE.NAME
    END
    IF NOT(YSTART.DATE) AND NOT(YEND.DATE) THEN
        YSTART.DATE = Y.LAST.WORK.DAY[1,6]:'01'
        COMI = YSTART.DATE
        CALL LAST.DAY.OF.THIS.MONTH
        YEND.DATE = COMI
    END
    RETURN

PROCESS:
********
    YFILE.VAL = "ACCOUNT.NUMBER|EFFECTIVE DATE|AMOUNT|ACTIVITY ID|ACTIVITY"
    SEL.AACMD = "SSELECT ":FN.AA.ARRANGEMENT.ACTIVITY:" WITH ACTIVITY EQ 'LENDING-SETTLE-RP.PAGO.ANTICIPADO' AND (EFFECTIVE.DATE GE ":YSTART.DATE:" AND EFFECTIVE.DATE LE ":YEND.DATE:")"
    CALL EB.READLIST(SEL.AACMD,SEL.REC,'',SEL.LIST,SEL.ERR)
    ACTIVTTY.VAL = "LENDING-SETTLE-RP.PAGO.ANTICIPADO"
    LOOP
        REMOVE AAA.ID FROM SEL.REC SETTING AAA.POSN
    WHILE AAA.ID:AAA.POSN
        ERR.AAA = ''; R.AA.ARRANGEMENT.ACTIVITY = ''; YTOTAL.AMOUNT = 0
        CALL F.READ(FN.AA.ARRANGEMENT.ACTIVITY,AAA.ID,R.AA.ARRANGEMENT.ACTIVITY,F.AA.ARRANGEMENT.ACTIVITY,ERR.AAA)
        AA.ARR.ID = R.AA.ARRANGEMENT.ACTIVITY<AA.ARR.ACT.ARRANGEMENT>
        AA.EFF.ID = R.AA.ARRANGEMENT.ACTIVITY<AA.ARR.ACT.EFFECTIVE.DATE>
        YTOTAL.AMOUNT = R.AA.ARRANGEMENT.ACTIVITY<AA.ARR.ACT.TXN.AMOUNT.LCY>
        ERR.AAB = ''; R.AA.ACTIVITY.BALANCES = ''; ACT.REF = ''; V.POSN = 0; YTOT.AMT = 0
        CALL F.READ(FN.AA.ACTIVITY.BALANCES,AA.ARR.ID,R.AA.ACTIVITY.BALANCES,F.AA.ACTIVITY.BALANCES,ERR.AAB)
        ACT.REF = R.AA.ACTIVITY.BALANCES<AA.ACT.BAL.ACTIVITY.REF>
        LOCATE AAA.ID IN ACT.REF<1,1> SETTING V.POSN THEN
            GOSUB PROCESS.SUB
        END
        ERR.AA.ARR = ''; R.AA.ARRANGEMENT = ''; YACCOUNT.NO = ''; YTEMP.AMT = ''
        CALL F.READ(FN.AA.ARRANGEMENT,AA.ARR.ID,R.AA.ARRANGEMENT,F.AA.ARRANGEMENT,ERR.AA.ARR)
        YACCOUNT.NO  = R.AA.ARRANGEMENT<AA.ARR.LINKED.APPL.ID>
        YTEMP.AMT = YTOTAL.AMOUNT - YTOT.AMT
        IF YTOT.AMT GT 0 THEN
            YFILE.VAL<-1> = YACCOUNT.NO:"|":AA.EFF.ID:"|":YTOT.AMT:"|":AAA.ID:"|":ACTIVTTY.VAL
        END
    REPEAT

    WRITE YFILE.VAL ON F.CHK.DIR, Y.FINAL.OUT.FILE.NAME ON ERROR
        Y.ERR.MSG = "Unable to Write ":Y.FINAL.OUT.FILE.NAME
        RETURN
    END
    R.REDO.H.REPORTS.PARAM<REDO.REP.PARAM.FIELD.VALUE,Y.FRM.POS> = ''
    R.REDO.H.REPORTS.PARAM<REDO.REP.PARAM.FIELD.VALUE,Y.TO.POS> = ''
    CALL F.WRITE(FN.REDO.H.REPORTS.PARAM,Y.PARAM.ID,R.REDO.H.REPORTS.PARAM)
    RETURN

PROCESS.SUB:
************
    YTOT.AMT= 0
    ACT.PROP = R.AA.ACTIVITY.BALANCES<AA.ACT.BAL.PROPERTY,V.POSN>
    ACT.PROP.AMT = R.AA.ACTIVITY.BALANCES<AA.ACT.BAL.PROPERTY.AMT,V.POSN>
    CNT = 1
    LOOP
        REMOVE ACT.ID FROM ACT.PROP SETTING ACT.POSN
    WHILE ACT.ID:ACT.POSN
        ACT.VAL = ''
        ACT.VAL = FIELD(ACT.ID,'.',2)
        LOCATE ACT.VAL IN YBALANC.TYP<1,1> SETTING YPOSN THEN
            YTOT.AMT += R.AA.ACTIVITY.BALANCES<AA.ACT.BAL.PROPERTY.AMT,V.POSN,CNT>
        END
        CNT++
    REPEAT
    RETURN
END
