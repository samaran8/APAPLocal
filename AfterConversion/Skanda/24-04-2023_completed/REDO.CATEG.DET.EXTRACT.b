$PACKAGE APAP.LAPAP
SUBROUTINE REDO.CATEG.DET.EXTRACT
** 24-04-2023 R22 Auto Conversion 
** 24-04-2023 Skanda R22 Manual Conversion - No changes

    $INSERT I_COMMON ;* R22 Auto conversion
    $INSERT I_EQUATE ;* R22 Auto conversion
    $INSERT I_F.AA.ARRANGEMENT ;* R22 Auto conversion
    $INSERT I_F.AA.ARRANGEMENT.ACTIVITY ;* R22 Auto conversion
    $INSERT I_F.STMT.ENTRY ;* R22 Auto conversion
    $INSERT I_F.DATES ;* R22 Auto conversion
    $INSERT I_ENQUIRY.COMMON ;* R22 Auto conversion


    GOSUB INIT
    GOSUB PROCESS
RETURN

INIT:
******
    EXTRACT.FILE.ID.1 = 'CATEGORY14700_DETAIL816.txt'
    FN.AC.SUB.ACC = 'F.AC.SUB.ACCOUNT' ; F.AC.SUB.ACC = ''; Y.FINAL.ARRAY = ''
    CALL OPF(FN.AC.SUB.ACC,F.AC.SUB.ACC)
    FN.STMT.ENTRY = 'F.STMT.ENTRY' ; F.STMT.ENTRY = ''
    CALL OPF(FN.STMT.ENTRY,F.STMT.ENTRY)
    FN.AA.ARRANGEMENT.ACTIVITY = 'F.AA.ARRANGEMENT.ACTIVITY'; F.AA.ARRANGEMENT.ACTIVITY = ''
    CALL OPF(FN.AA.ARRANGEMENT.ACTIVITY,F.AA.ARRANGEMENT.ACTIVITY)
    FN.AA.ARRANGEMENT = 'F.AA.ARRANGEMENT'; F.AA.ARRANGEMENT = ''
    CALL OPF(FN.AA.ARRANGEMENT,F.AA.ARRANGEMENT)
    FN.CHK.DIR = '../bnk.interface/REG.REPORTS'
    F.CHK.DIR = ''
    CALL OPF(FN.CHK.DIR,F.CHK.DIR)
    LAST.WORK.DAY = R.DATES(EB.DAT.LAST.WORKING.DAY)
    Y.TODAY = TODAY
    CALL CDT('',Y.TODAY,'-1C')
    IF LAST.WORK.DAY[5,2] NE Y.TODAY[5,2] THEN
        COMI = LAST.WORK.DAY[1,6]:'01'
        CALL LAST.DAY.OF.THIS.MONTH
        Y.TODAY = COMI
    END

    STR.DATE = Y.TODAY[1,4]:"0101"
    END.DATE = Y.TODAY
RETURN

PROCESS:
********
    SEL.CMD = ''; SEL.REC = ''; SEL.LIST = ''; ERR.SEL = ''; YGRP.ARRY = ''; YGP.STMT.SID.LIST = ''
    SEL.CMD = "SELECT ":FN.STMT.ENTRY:" WITH ACCOUNT.NUMBER LIKE ...14700... AND TRANSACTION.CODE EQ '816'"
    CALL EB.READLIST(SEL.CMD,SEL.REC,'',SEL.LIST,ERR.SEL)
    LOOP
        REMOVE SUB.ID FROM SEL.REC SETTING SA.POSN
    WHILE SUB.ID:SA.POSN
        GOSUB PROCESS.1.LOOP
    REPEAT
    CALL F.WRITE(FN.CHK.DIR,EXTRACT.FILE.ID.1,Y.FINAL.ARRAY)
RETURN

PROCESS.1.LOOP:
***************
    ENT.ID = ''
    ENT.ID = SUB.ID
    FXBCO.AMT = ''; YTTT.AMT = ''; YTEMP.VAL = ''; CUST.ID = ''; TRANS.REF = ''; YCRF.TYPE = ''
    FT.COMM.AMT = ''; YTEMP.TYP = ''; AMT.LCY = 0; BOOK.DTE = ''; TRANS.CODE = ''
    COMP.CDE = '';YACT.ID = ''; AACONT.ID = ''; AA.ARR.ID = ''; YACCOUNT.NO = ''; ARRCOMP.ID = ''
    GOSUB READ.STMT.ENTRY
    THER.REF = R.STMT.ENTRY<AC.STE.THEIR.REFERENCE>
    AMT.LCY = R.STMT.ENTRY<AC.STE.AMOUNT.LCY>
    TRANS.REF = R.STMT.ENTRY<AC.STE.TRANS.REFERENCE>
    BOOK.DTE = R.STMT.ENTRY<AC.STE.BOOKING.DATE>
    TRANS.CODE = R.STMT.ENTRY<AC.STE.TRANSACTION.CODE>
    COMP.CDE = R.STMT.ENTRY<AC.STE.COMPANY.CODE>
    YACT.ID = R.STMT.ENTRY<AC.STE.ACCOUNT.NUMBER>
    YCRF.TYPE = R.STMT.ENTRY<AC.STE.CRF.TYPE>
    TRANS.REF = FIELD(TRANS.REF,'\',1)
    IF TRANS.REF[1,5] EQ 'AAACT' THEN
        ERR.AAA = ''; R.AA.ARRANGEMENT.ACTIVITY = ''; YTOTAL.AMOUNT = 0
        CALL F.READ(FN.AA.ARRANGEMENT.ACTIVITY,TRANS.REF,R.AA.ARRANGEMENT.ACTIVITY,F.AA.ARRANGEMENT.ACTIVITY,ERR.AAA)
        AA.ARR.ID = R.AA.ARRANGEMENT.ACTIVITY<AA.ARR.ACT.ARRANGEMENT>
        AACONT.ID = R.AA.ARRANGEMENT.ACTIVITY<AA.ARR.ACT.TXN.CONTRACT.ID>
        ERR.AA.ARR = ''; R.AA.ARRANGEMENT = ''; YACCOUNT.NO = ''
        CALL F.READ(FN.AA.ARRANGEMENT,AA.ARR.ID,R.AA.ARRANGEMENT,F.AA.ARRANGEMENT,ERR.AA.ARR)
        YACCOUNT.NO  = R.AA.ARRANGEMENT<AA.ARR.LINKED.APPL.ID>
        CUST.ID = R.AA.ARRANGEMENT<AA.ARR.CUSTOMER>
        ARRCOMP.ID = R.AA.ARRANGEMENT<AA.ARR.CO.CODE>
    END
    Y.FINAL.ARRAY<-1> = ENT.ID:",":YACT.ID:",":TRANS.CODE:",":TRANS.REF:",":CUST.ID:",":AMT.LCY:",":COMP.CDE:",":BOOK.DTE:",":YACCOUNT.NO:",":AACONT.ID:",":ARRCOMP.ID:",":AA.ARR.ID:",":YCRF.TYPE
RETURN

READ.STMT.ENTRY:
****************
    R.STMT.ENTRY = ''; STMT.ENTRY.ERR = ''
    CALL F.READ(FN.STMT.ENTRY,ENT.ID,R.STMT.ENTRY,F.STMT.ENTRY,STMT.ENTRY.ERR)
RETURN

END
