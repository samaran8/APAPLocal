* @ValidationCode : MjoxOTg5MDY0MjAzOkNwMTI1MjoxNjg0ODU0Mzk1NTkwOklUU1M6LTE6LTE6MzUzOjE6ZmFsc2U6Ti9BOlIyMV9BTVIuMDotMTotMQ==
* @ValidationInfo : Timestamp         : 23 May 2023 20:36:35
* @ValidationInfo : Encoding          : Cp1252
* @ValidationInfo : User Name         : ITSS
* @ValidationInfo : Nb tests success  : N/A
* @ValidationInfo : Nb tests failure  : N/A
* @ValidationInfo : Rating            : 353
* @ValidationInfo : Coverage          : N/A
* @ValidationInfo : Strict flag       : true
* @ValidationInfo : Bypass GateKeeper : false
* @ValidationInfo : Compiler Version  : R21_AMR.0
* @ValidationInfo : Copyright Temenos Headquarters SA 1993-2021. All rights reserved.
$PACKAGE APAP.REDOBATCH
SUBROUTINE REDO.B.RENEW.PROCESS(Y.LATAM.CARD.LIST)
*********************************************************************************************************
*Company   Name    : APAP Bank
*Developed By      : Temenos Application Management
*Program   Name    : REDO.B.RENEW.PROCESS
*--------------------------------------------------------------------------------------------------------
*Description       :
*--------------------------------------------------------------------------------------------------------
*Modification Details:
*=====================
*    Date               Who                       Reference               Description
*   ------             ------                    -------------            -------------
*  07/08/2010       SWAMINATHAN.S.R            ODR-2010-03-0400 B166      Initial Creation
*  27/05/2011       KAVITHA                    PACS00063156               Issue fix
*  8 JUN 2011       KAVITHA                    PACS00063138               Issue fix
*  9 Jul 2011       Balagurunathan             PACS00063156               Renewal frequency calculatin changed
* Date                   who                   Reference              
* 13-04-2023         CONVERSTION TOOL     R22 AUTO CONVERSTION - FM TO @FM AND VM TO @VM AND COMMENTED THE I_F.COMPANY
* 13-04-2023          ANIL KUMAR B        R22 MANUAL CONVERSTION -NO CHANGES
*********************************************************************************************************
    $INSERT I_COMMON
    $INSERT I_EQUATE
    $INSERT I_BATCH.FILES
    $INSERT I_F.COMPANY
    $INSERT I_GTS.COMMON
    $INSERT I_F.CARD.TYPE
    $INSERT I_F.DATES
*   $INSERT I_F.COMPANY   ;*R22 AUTO CONVERSTION COMMENTED THE I_F.COMPANY
    $INSERT I_F.CUSTOMER
    $INSERT I_REDO.B.RENEW.PROCESS.COMMON
    $INSERT I_F.LATAM.CARD.ORDER
    $INSERT I_F.REDO.CARD.RENEWAL
    $INSERT I_F.REDO.CARD.REQUEST

* PACS00063156 -S


    GOSUB PROCESS

RETURN

********
PROCESS:
********

    Y.NO.OF.MONTHS = ''; Y.BIN = '';Y.EXPIRY.DATE='';Y.STOCK.SERIES.ID='';TYPE.CARD='';Y.CUSTOMER.ID='';Y.ACCOUNT.ID='';CO.CODE='';Y.CUST.NAME='';Y.NO.OF.MONTHS=''

    Y.RECORD = ''
    FLAG.FS = ''
    Y.CUSTOMER.ID = ''
    Y.ACCOUNT.ID = ''
    Y.CUST.NAME  = ''
    STORED.CNTR = ''

    Y.LCO.ID = Y.LATAM.CARD.LIST
    Y.CARD.TYPE =  FIELD(Y.LCO.ID,'.',1,1)
    CALL F.READ(FN.CARD.TYPE,Y.CARD.TYPE,R.CARD.TYPE,F.CARD.TYPE,Y.CARD.ERR)
    IF R.CARD.TYPE THEN
        GOSUB NEXT.REMAIN.PROCESS
    END

RETURN
*----------------
NEXT.REMAIN.PROCESS:

    Y.NO.OF.MONTHS = R.CARD.TYPE<CARD.TYPE.RENEWAL.FQU>

    Y.BIN = R.CARD.TYPE<CARD.TYPE.LOCAL.REF,Y.CT.BIN.POS>
    CALL F.READ(FN.LATAM.CARD.ORDER,Y.LCO.ID,R.LATAM.CARD.ORDER,F.LATAM.CARD.ORDER,Y.ORDER.ERR)
    IF R.LATAM.CARD.ORDER THEN
        ISSUE.DATE = R.LATAM.CARD.ORDER<CARD.IS.ISSUE.DATE>
        EXPIRY.DATE = R.LATAM.CARD.ORDER<CARD.IS.EXPIRY.DATE>
        RENEWAL.DATE = R.LATAM.CARD.ORDER<CARD.IS.RENEWAL.DATE>

        Y.STOCK.SERIES.ID = R.LATAM.CARD.ORDER<CARD.IS.STOCK.SERIERS.ID>
        TYPE.CARD = R.LATAM.CARD.ORDER<CARD.IS.TYPE.OF.CARD>
        PRIMARY.CARD = R.LATAM.CARD.ORDER<CARD.IS.CARD.NUMBER,2>
        PRIMARY.CARD = FIELD(PRIMARY.CARD,".",2)

        IF TYPE.CARD EQ "PRINCIPAL" THEN
            Y.CUSTOMER.ID = R.LATAM.CARD.ORDER<CARD.IS.CUSTOMER.NO><1,1>
        END ELSE
            Y.CUSTOMER.ID = R.LATAM.CARD.ORDER<CARD.IS.CUSTOMER.NO><1,2>
        END

        Y.ACCOUNT.ID =  R.LATAM.CARD.ORDER<CARD.IS.ACCOUNT><1,1>
        CO.CODE = R.LATAM.CARD.ORDER<CARD.IS.CO.CODE>
        Y.PROSPECT.ID=R.LATAM.CARD.ORDER<CARD.IS.PROSPECT.ID>


        Y.CUST.NAME = R.LATAM.CARD.ORDER<CARD.IS.NAME.ON.PLASTIC><1,1>
    END

    FETCH.LWD = R.DATES(EB.DAT.LAST.WORKING.DAY)
    FETCH.NWD = R.DATES(EB.DAT.TODAY)


    GOSUB RECORD.ASSIGN
    GOSUB UPDATE.RENEWAL
    FLAG.FS = 1

    IF FLAG.FS EQ 1 THEN
        GOSUB OFS.PROCESS
        FLAG.FS = ''
    END

RETURN
*****************
RECORD.ASSIGN:
******************
*PACS00063138-S
    IF Y.RECORD THEN
        GOSUB QTY.NO
    END ELSE
        Y.RECORD<REDO.CARD.REQ.AGENCY> = CO.CODE
        Y.RECORD<REDO.CARD.REQ.DATE> = RENEWAL.DATE
        Y.RECORD<REDO.CARD.REQ.CARD.TYPE,-1> = Y.CARD.TYPE
        Y.RECORD<REDO.CARD.REQ.STATUS> = "1"
        Y.RECORD<REDO.CARD.REQ.CARD.SERIES.ID,-1> = Y.STOCK.SERIES.ID
        Y.RECORD<REDO.CARD.REQ.PERS.CARD,-1> = "REGULAR"
        Y.RECORD<REDO.CARD.REQ.VAULT.QTY,-1> = "SAME: ":Y.LCO.ID
        Y.RECORD<REDO.CARD.REQ.COMMENTS,-1> = "Renewal of card : ":Y.LCO.ID
        Y.RECORD<REDO.CARD.REQ.CUSTOMER.NO,-1> = Y.CUSTOMER.ID
        Y.RECORD<REDO.CARD.REQ.ACCOUNT.NO,-1> = Y.ACCOUNT.ID
        Y.RECORD<REDO.CARD.REQ.CUSTOMER.NAME,-1> = Y.CUST.NAME
        Y.RECORD<REDO.CARD.REQ.BRANCH.ORDERQTY,-1> = 1
        Y.RECORD<REDO.CARD.REQ.TYPE.OF.CARD> = TYPE.CARD
        Y.RECORD<REDO.CARD.REQ.PRIMARY.CARD> = PRIMARY.CARD
        Y.RECORD<REDO.CARD.REQ.RENEWAL.FLAG> = "YES"
        Y.RECORD<REDO.CARD.REQ.PROSPECT.ID> = Y.PROSPECT.ID
    END

*PACS00063138-E
RETURN
*********
QTY.NO:
*********

    LOCATE Y.CARD.TYPE IN Y.RECORD<REDO.CARD.REQ.CARD.TYPE> SETTING QTY.POS THEN
        Y.RECORD<REDO.CARD.REQ.CUSTOMER.NO,QTY.POS,-1> = Y.CUSTOMER.ID
        Y.RECORD<REDO.CARD.REQ.ACCOUNT.NO,QTY.POS,-1> = Y.ACCOUNT.ID
        Y.RECORD<REDO.CARD.REQ.CUSTOMER.NAME,QTY.POS,-1> = Y.CUST.NAME
        STORED.CNTR = Y.RECORD<REDO.CARD.REQ.BRANCH.ORDERQTY,QTY.POS> + 1
        Y.RECORD<REDO.CARD.REQ.BRANCH.ORDERQTY,QTY.POS> = STORED.CNTR

    END

RETURN
************
OFS.PROCESS:
*************

    Y.APP.NAME =  "REDO.CARD.REQUEST"
    Y.OFSFUNCT = 'I'
    Y.PROCESS = "PROCESS"
    Y.GTSMODE = ""
    Y.NO.OF.AUTH = "0"
    Y.TRANSACTION.ID = ""
    OFSRECORD = ""
    Y.OFSVERSION = 'REDO.CARD.REQUEST,OFS'

    CALL OFS.BUILD.RECORD(Y.APP.NAME,Y.OFSFUNCT,Y.PROCESS,Y.OFSVERSION,Y.GTSMODE,Y.NO.OF.AUTH,Y.TRANSACTION.ID,Y.RECORD,OFSRECORD)

    TOTAL.COMM.CNTR = DCOUNT(OFSRECORD,",")

    MODIFY.PART = FIELD(OFSRECORD,",",3,1)
    TOT.MODIFY.CNT = DCOUNT(MODIFY.PART,"/")

    MODIFY.CO.CODE = FIELD(MODIFY.PART,"/",3,1)
    MODIFY.CO.CODE = CO.CODE
    MODIFY.CO.CODE = MODIFY.CO.CODE:"/"

    FIRST.MOD.PART = FIELD(MODIFY.PART,"/",1,2)
    FIRST.MOD.PART = FIRST.MOD.PART:"/"

    REST.MOD.PART =  FIELD(MODIFY.PART,"/",4,TOT.MODIFY.CNT)

    NEW.MODIFY.PART = FIRST.MOD.PART:MODIFY.CO.CODE:REST.MOD.PART
    NEW.MODIFY.PART = NEW.MODIFY.PART:","

    FIRST.PART = FIELD(OFSRECORD,",",1,2)
    FIRST.PART = FIRST.PART:","

    REST.PART = FIELD(OFSRECORD,",",4,TOTAL.COMM.CNTR)

    Y.FINAL.MSG = FIRST.PART:NEW.MODIFY.PART:REST.PART


    Y.MSG = Y.FINAL.MSG
    Y.MSG.KEY = ""
    Y.OFS.SOURCE.ID = "DEBIT.CARD"
    Y.OPTIONS = ""

    CALL OFS.POST.MESSAGE(Y.MSG,Y.MSG.KEY,Y.OFS.SOURCE.ID,Y.OPTIONS)

RETURN
*-------------
UPDATE.RENEWAL:
****************
    R.CARD.RENEW = ''

*PACS00063138 -S

    CARD.RENW.ID = Y.CUSTOMER.ID:"-":Y.ACCOUNT.ID
    CALL F.READ(FN.CARD.RENEW,CARD.RENW.ID,R.CARD.RENEW,F.CARD.RENEW,RENEW.ERR)
    IF R.CARD.RENEW THEN

        GET.LOC.LIST = R.CARD.RENEW<REDO.RENEW.PREV.CARD.NO>
        CHANGE @VM TO @FM IN GET.LOC.LIST
        LOCATE Y.LCO.ID IN GET.LOC.LIST SETTING FIND.POS THEN
            R.CARD.RENEW<REDO.RENEW.AUTO.RENEW,FIND.POS> = "YES"
            R.CARD.RENEW<REDO.RENEW.ISSUE.TYPE,FIND.POS> = "SAME"
        END

    END

    CALL F.WRITE(FN.CARD.RENEW,CARD.RENW.ID,R.CARD.RENEW)
*PACS00063138 -E

RETURN
*-----------------------
*PACS00063156-E

END
