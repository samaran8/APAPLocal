* @ValidationCode : MjoyNzQxMDc2OTk6Q3AxMjUyOjE2ODQ4MzYwNDkxMDQ6SVRTUzotMTotMToyMzkyOjE6ZmFsc2U6Ti9BOlIyMV9BTVIuMDotMTotMQ==
* @ValidationInfo : Timestamp         : 23 May 2023 15:30:49
* @ValidationInfo : Encoding          : Cp1252
* @ValidationInfo : User Name         : ITSS
* @ValidationInfo : Nb tests success  : N/A
* @ValidationInfo : Nb tests failure  : N/A
* @ValidationInfo : Rating            : 2392
* @ValidationInfo : Coverage          : N/A
* @ValidationInfo : Strict flag       : true
* @ValidationInfo : Bypass GateKeeper : false
* @ValidationInfo : Compiler Version  : R21_AMR.0
* @ValidationInfo : Copyright Temenos Headquarters SA 1993-2021. All rights reserved.
$PACKAGE APAP.REDOAPAP
SUBROUTINE REDO.APAP.NOF.INV.GEN.RPT.CP(Y.FINAL.ARRAY)
*********************************************************************************************************
*Company   Name    : ASOCIACION POPULAR DE AHORROS Y PRESTAMOS
*Program   Name    :
*--------------------------------------------------------------------------------------------------------
*Description       : This Nofile enquiry routine is used to retrieve the records from AZ.ACCOUNT,ACCOUNT and
*CUSTOMER applications for generating the Report
*In Parameter      :
*Out Parameter     : Y.FINAL.ARRAY
*Linked With       :Enquiry REDO.APAP.ENQ.INV.GEN.RPT
*--------------------------------------------------------------------------------------------------------
*Modification Details:
*=====================
*    Date            Who                            Reference                      Description
*   ------         ------                         -------------                    -------------
*  07/12/2012    Marimuthu S                       PACS00237946                       Cob performance
* Date                   who                   Reference              
* 06-04-2023         CONVERSTION TOOL     R22 AUTO CONVERSTION FM TO @FM AND VM TO @VM AND = TO EQ AND CONVERT TO CHANGE AND ++ TO += 1
* 06-04-2023          ANIL KUMAR B        R22 MANUAL CONVERSTION -NO CHANGES
*********************************************************************************************************

    $INSERT I_COMMON
    $INSERT I_EQUATE
    $INSERT I_ENQUIRY.COMMON
    $INSERT I_F.AZ.ACCOUNT
    $INSERT I_F.ACCOUNT
    $INSERT I_F.CUSTOMER
    $INSERT I_F.COLLATERAL
    $INSERT I_F.ACCT.ACTIVITY
    $INSERT I_F.RELATION
    $INSERT I_F.DATES
    $INSERT I_F.STMT.ENTRY
    $INSERT I_F.EB.LOOKUP
* Tus start
    $INSERT I_F.EB.CONTRACT.BALANCES
* Tus end

    GOSUB INIT
    GOSUB OPENFILES
    GOSUB MAIN.PARA
RETURN

*******
INIT:
*******

    FN.AZ.ACCOUNT = 'F.AZ.ACCOUNT'
    F.AZ.ACCOUNT = ''


    FN.ACCOUNT = 'F.ACCOUNT'
    F.ACCOUNT = ''

    FN.CUSTOMER = 'F.CUSTOMER'
    F.CUSTOMER = ''

    FN.COLLATERAL = 'F.COLLATERAL'
    F.COLLATERAL = ''

    FN.ACCT.ACTIVITY = 'F.ACCT.ACTIVITY'
    F.ACCT.ACTIVITY = ''

    FN.RELATION = 'F.RELATION'
    F.RELATION = ''

    FN.ACCT.ENT.TODAY = 'F.ACCT.ENT.TODAY'
    F.ACCT.ENT.TODAY = ''

*  FN.AC.COLLATERAL = 'F.AC.COLLATERAL'
*  F.AC.COLLATERAL = ''
    FN.EB.CONTRACT.BALANCES = "F.EB.CONTRACT.BALANCES"        ;*/ TUS START
    F.EB.CONTRACT.BALANCES = ""                ;*/ TUS END

    FN.ALTERNATE.ACCOUNT = 'F.ALTERNATE.ACCOUNT'
    F.ALTERNATE.ACCOUNT = ''

    FN.EB.LOOKUP = 'F.EB.LOOKUP'
    F.EB.LOOKUP = ''

    Y.PAY.METHOD.POS = ''
    Y.CLIENT.TYPE.POS = ''
    Y.INVEST.TYPE.POS = ''
    Y.ARR.ID1 = ''
    Y.AGENCY = ''
    Y.INVEST.TYPE = ''
    Y.CLIENT.TYPE = ''
    Y.CURRENCY = ''
    Y.BDY.AMOUNT = ''
    Y.PAY.METHOD = ''
    Y.BDY.TERM = ''
    Y.AZ.SORT.VAL = ''
    Y.SORT.ARR = ''
    Y.PRINCIPAL = ''
    Y.WORK.BAL = ''
    Y.BDY.CURR.BAL = ''
    Y.BDY.PLEDGED.AMT = 0.00
    Y.BDY.INTEREST.RATE = 0.00
    Y.BDY.AMOUNT1 = 0.00
    Y.BDY.STATUS1 = ''
    Y.BDY.STATUS2 = ''
    REGION.CODE = ''
    Y.DIFF = 'C'
    Y.CUS = '';Y.FLAG = ''
    Y.ACC.LIST = ''
    Y.REINVESTED.DEPOSIT = ''
    TRNS.THREE.POS = ''
    Y.BDY.CUSTOMER.NAME = ''
    Y.FLAG1 = '';Y.BDY.REGION = ''
    CUS.FINAL.VAL = ''


    GOSUB GET.LOCAL.REF

RETURN

***********
OPENFILES:
***********

    CALL OPF(FN.AZ.ACCOUNT, F.AZ.ACCOUNT)
    CALL OPF(FN.ACCOUNT, F.ACCOUNT)
    CALL OPF(FN.CUSTOMER, F.CUSTOMER)
    CALL OPF(FN.COLLATERAL,F.COLLATERAL)
    CALL OPF(FN.ACCT.ACTIVITY,F.ACCT.ACTIVITY)
    CALL OPF(FN.RELATION,F.RELATION)
    CALL OPF(FN.ACCT.ENT.TODAY,F.ACCT.ENT.TODAY)
*  CALL OPF(FN.AC.COLLATERAL,F.AC.COLLATERAL)        ;*/ TUS START/END
    CALL OPF(FN.EB.CONTRACT.BALANCES,F.EB.CONTRACT.BALANCES)
    CALL OPF(FN.ALTERNATE.ACCOUNT,F.ALTERNATE.ACCOUNT)
    CALL OPF(FN.EB.LOOKUP,F.EB.LOOKUP)

RETURN

***********
MAIN.PARA:
***********

    SEL.CMD.AZ = 'SELECT ':FN.AZ.ACCOUNT:' WITH CO.CODE EQ ':ID.COMPANY

    GOSUB SEL.STMT.FORMATION

    LOOP

        REMOVE Y.AZ.ID FROM Y.FINAL.AZ.IDS SETTING POS
    WHILE Y.AZ.ID:POS

        GOSUB GET.REGION

        IF Y.FLAG NE '1' AND Y.FLAG1 NE '1' THEN

            Y.FINAL.ARRAY<-1> = Y.BDY.AGENCY:'*':Y.BDY.ACCT.EXE:'*':Y.BDY.REGION:'*':Y.BDY.INV.TYPE:'*':Y.BDY.PRE.INV.NO:"*":Y.BDY.INV.NO:"*":Y.BDY.CUSTOMER.NAME:"*":Y.BDY.CUSTOMER:"*":Y.BDY.CLIENT.TYPE:"*":Y.BDY.OPENING.DATE:"*":Y.BDY.CURRENCY:"*":Y.BDY.AMOUNT1:"*":Y.BDY.TERM:"*":Y.BDY.INTEREST.RATE:"*":Y.BDY.MATURITY.DATE:"*":Y.BDY.INT.MTD.PAY:"*":Y.BDY.INT.PAYDATE:'*':Y.BDY.CDT.ACCT.NO:"*":Y.BDY.CURR.BAL:"*":Y.BDY.ACR.INT:"*":Y.BDY.STATUS:"*":Y.BDY.STATUS1:"*":Y.BDY.STATUS2:"*":Y.BDY.NOTIFICATION:"*":Y.BDY.PLEDGED.AMT:"*":Y.BDY.ROLLOVER.DATE
*                                 1              2                  3                  4                      5                6                      7                      8                    9                     10                   11               12               13                     14                15                      16                       17               18                  19               20                  21                   22              23                       24                      25                         26
        END

        Y.FLAG = '';Y.FLAG1 = '';Y.BDY.STATUS = '';Y.BDY.PLEDGED.AMT = '';Y.BDY.REGION = ''

    REPEAT

RETURN

*************
GET.REGION:
*************
    Y.CNT1 = ''

    CALL F.READ(FN.AZ.ACCOUNT,Y.AZ.ID,R.AZ.ACCOUNT,F.AZ.ACCOUNT,F.ERR)

    Y.ID1 = R.AZ.ACCOUNT<AZ.CUSTOMER>

    CALL F.READ(FN.CUSTOMER,Y.ID1,R.CUSTOMER,F.CUSTOMER,ERR)
    Y.CLI.TYPE = R.CUSTOMER<EB.CUS.LOCAL.REF,Y.L.CU.TIPO.CL.POS>

    IF Y.CLIENT.TYPE THEN
        IF Y.CLI.TYPE NE Y.CLIENT.TYPE THEN
            Y.FLAG = 1
            RETURN
        END
    END

    CALL F.READ(FN.ACCOUNT,Y.AZ.ID,R.ACC.REC,F.ACCOUNT,F.ERR)
    Y.MTD.PAY = R.ACC.REC<AC.LOCAL.REF,Y.L.AC.PAYMT.MODE.POS>
    Y.BDY.INT.MTD.PAY = Y.MTD.PAY
    IF Y.BDY.INT.MTD.PAY EQ ' ' THEN
        Y.LIQ.ACT.ID = R.AZ.ACCOUNT<AZ.INTEREST.LIQU.ACCT>
        CALL F.READ(FN.ACCOUNT,Y.LIQ.ACT.ID,R.ACCT.REC,F.ACCOUNT,F.LIQ.ERR)
        Y.BDY.INT.MTD.PAY = R.ACCT.REC<AC.LOCAL.REF,Y.L.AC.PAYMT.MODE.POS>
    END


    Y.CUSTOMER.ID =R.AZ.ACCOUNT<AZ.CUSTOMER>

    CALL F.READ(FN.CUSTOMER,Y.CUSTOMER.ID,R.CUS.REC,F.CUSTOMER,F.ERR)
    Y.ACC.OFF=R.CUS.REC<EB.CUS.ACCOUNT.OFFICER>
    Y.CNT = LEN(Y.ACC.OFF)

    IF Y.CNT GT '8' THEN
        Y.CNT1 = Y.CNT-8
        Y.CNT2 = Y.CNT1+1
        Y.BDY.REGION = Y.ACC.OFF[Y.CNT2,2]
    END

    IF Y.CNT EQ 8 THEN
        Y.BDY.REGION = Y.ACC.OFF[1,2]
    END

    Y.BDY.AGENCY = R.AZ.ACCOUNT<AZ.CO.CODE>
    Y.BDY.ACCT.EXE = R.ACC.REC<AC.ACCOUNT.OFFICER>
    Y.BDY.INV.TYPE = R.AZ.ACCOUNT<AZ.ALL.IN.ONE.PRODUCT>


    Y.BDY.PRE.INV.NO = R.ACC.REC<AC.ALT.ACCT.ID>
    Y.BDY.INV.NO = Y.AZ.ID
    GOSUB GET.CUSTOMER.NAME
    Y.BDY.CUSTOMER = Y.CUSTOMER.ID
    Y.CLIENT.TYPE1 = R.CUS.REC<EB.CUS.LOCAL.REF><1,Y.L.CU.TIPO.CL.POS>
    Y.BDY.CLIENT.TYPE = Y.CLIENT.TYPE1

    Y.BDY.OPENING.DATE = R.AZ.ACCOUNT<AZ.VALUE.DATE>
    Y.BDY.CURRENCY = R.AZ.ACCOUNT<AZ.CURRENCY>

    Y.BDY.MATURITY.DATE = R.AZ.ACCOUNT<AZ.FINAL.MATURITY>
    Y.MATURITY.DATE = R.AZ.ACCOUNT<AZ.MATURITY.DATE>
    Y.BDY.INT.PAYDATE1 = R.AZ.ACCOUNT<AZ.FREQUENCY>
    Y.PAYDATE = Y.BDY.INT.PAYDATE1[1,8]
    Y.BDY.INT.PAYDATE = Y.PAYDATE

    Y.BDY.AMOUNT1 =R.AZ.ACCOUNT<AZ.LOCAL.REF><1,Y.L.AZ.ORG.DP.AMT.POS>

    IF Y.BDY.OPENING.DATE NE '' AND Y.MATURITY.DATE NE '' THEN
        Y.DIFF = 'C'
        CALL CDD(REGION.CODE,Y.BDY.OPENING.DATE,Y.MATURITY.DATE,Y.DIFF)
        Y.BDY.TERM = Y.DIFF
    END

    Y.BDY.INTEREST.RATE = R.AZ.ACCOUNT<AZ.INTEREST.RATE>
    GOSUB GET.INT.PAY.METHOD
    Y.BDY.CDT.ACCT.NO = R.AZ.ACCOUNT<AZ.INTEREST.LIQU.ACCT>

    GOSUB GET.CUR.BALANCE

    Y.BDY.ACR.INT = R.ACC.REC<AC.ACCR.CR.AMOUNT>

    GOSUB GET.STATUS

    Y.NOTIFY = R.ACC.REC<AC.LOCAL.REF><1,Y.L.AC.NOTIFY.1.POS,1>
    Y.BDY.NOTIFICATION = Y.NOTIFY
    GOSUB COLL.VALUE

    Y.BDY.ROLLOVER.DATE = R.AZ.ACCOUNT<AZ.ROLLOVER.DATE>

RETURN

**************
COLL.VALUE:
**************

*  CALL F.READ(FN.AC.COLLATERAL,Y.AZ.ID,R.AC.COLL,F.AC.COLLATERAL,AC.COL.ERR)  ;* Tus Start
*  IF NOT(R.AC.COLL) THEN
    CALL F.READ(FN.EB.CONTRACT.BALANCES,Y.AZ.ID,R.ECB,F.EB.CONTRACT.BALANCES,ECB.ERR1)
    IF NOT(R.ECB) THEN   ;* Tus End
        CALL F.READ(FN.ACCOUNT,Y.AZ.ID,R.AC,F.ACCOUNT,AC.ERR)
        Y.ALT.ID = R.AC<AC.ALT.ACCT.ID>
*    CALL F.READ(FN.AC.COLLATERAL,Y.ALT.ID,R.AC.COLL,F.AC.COLLATERAL,AC.COL.ERR)  ;* Tus Start
        CALL F.READ(FN.EB.CONTRACT.BALANCES,Y.ALT.ID,R.ECB,F.EB.CONTRACT.BALANCES,ECB.ERR2)  ;* Tus End
    END

*  Y.COL.ID = R.AC.COLL<1>    ;* Tus Start
    Y.COL.ID = R.ECB<ECB.COLLATERAL>
    CHANGE @VM TO @FM IN Y.COL.ID   ;* Tus End  ;*R22 AUTO CONVERSTION CONVERT TO CHANGE
    CALL F.READ(FN.COLLATERAL,Y.COL.ID,R.COLLATERAL,F.COLLATERAL,F.ERR)
    Y.BDY.PLEDGED.AMT = R.COLLATERAL<COLL.EXECUTION.VALUE>

RETURN
********************
SEL.STMT.FORMATION:
********************

    SEL.CMD.AZ := ' BY CO.CODE BY ALL.IN.ONE.PRODUCT BY VALUE.DATE BY CURRENCY'

    CALL EB.READLIST(SEL.CMD.AZ,SEL.LIST.AZ1,'',NO.OF.REC.AZ,SEL.ERR.AZ)

    Y.FINAL.AZ.IDS = SEL.LIST.AZ1

RETURN

**************
GET.LOCAL.REF:
**************

    CUS.POS = ''
    APPLNS = 'CUSTOMER':@FM:'ACCOUNT':@FM:'AZ.ACCOUNT'
    FIEDS = 'L.CU.TIPO.CL':@FM:'L.AC.PAYMT.MODE':@VM:'L.AC.STATUS1':@VM:'L.AC.NOTIFY.1':@VM:'L.AC.REINVESTED':@VM:'L.AC.STATUS2':@FM:'L.AZ.PAYMT.MODE':@VM:'L.AZ.ORG.DP.AMT'
    CALL MULTI.GET.LOC.REF(APPLNS,FIEDS,CUS.POS)
    Y.L.CU.TIPO.CL.POS = CUS.POS <1,1>

    Y.L.AC.PAYMT.MODE.POS = CUS.POS<2,1>
    Y.ACCOUNT.STATUS1.POS = CUS.POS<2,2>
    Y.L.AC.NOTIFY.1.POS = CUS.POS<2,3>
    Y.L.AC.REINVESTED.POS = CUS.POS<2,4>
    Y.L.AC.STATUS2.POS = CUS.POS<2,5>

    Y.L.AZ.PAYMT.MODE.POS = CUS.POS<3,1>
    Y.L.AZ.ORG.DP.AMT.POS = CUS.POS<3,2>

RETURN

GET.STATUS:
*----------

    Y.CLOUSURE = R.ACC.REC<AC.CLOSURE.DATE>
    IF Y.CLOUSURE NE "" THEN
        Y.BDY.STATUS = "CLOSED"
    END
    Y.BDY.STATUS1 = R.ACC.REC<AC.LOCAL.REF><1,Y.ACCOUNT.STATUS1.POS>
    Y.BDY.STATUS2 =  R.ACC.REC<AC.LOCAL.REF><1,Y.L.AC.STATUS2.POS,1>

RETURN

GET.CUR.BALANCE:
*---------------

    Y.REINVESTED.DEPOSIT = R.ACC.REC<AC.LOCAL.REF,Y.L.AC.REINVESTED.POS>
    Y.PRINCIPAL = R.AZ.ACCOUNT<AZ.PRINCIPAL>
    IF Y.REINVESTED.DEPOSIT EQ 'YES' THEN
        Y.ACC.ID = R.ACC.REC<AC.INTEREST.LIQU.ACCT>
        CALL F.READ(FN.ACCOUNT,Y.ACC.ID,R.ACC1,F.ACCOUNT,ERR)
* Tus start
        R.ECB = ''
        ECB.ERR = ''
        CALL EB.READ.HVT("EB.CONTRACT.BALANCES",Y.ACC.ID,R.ECB,ECB.ERR)
*  Y.WORK.BAL = R.ACC1<AC.ONLINE.CLEARED.BAL>
        Y.WORK.BAL = R.ECB<ECB.ONLINE.CLEARED.BAL>
* Tus end
        Y.BDY.CURR.BAL = Y.PRINCIPAL + Y.WORK.BAL
    END ELSE
        Y.BDY.CURR.BAL = Y.PRINCIPAL
    END
RETURN

GET.INT.PAY.METHOD:
*====================
    Y.MTD.PAY = R.ACC.REC<AC.LOCAL.REF,Y.L.AC.PAYMT.MODE.POS>

    Y.BDY.INT.MTD.PAY = Y.MTD.PAY
    GOSUB READ.EBL
    IF Y.BDY.INT.MTD.PAY EQ ' ' THEN
        Y.LIQ.ACT.ID = R.AZ.ACCOUNT<AZ.INTEREST.LIQU.ACCT>
        CALL F.READ(FN.ACCOUNT,Y.LIQ.ACT.ID,R.ACCT.REC,F.ACCOUNT,F.LIQ.ERR)
        Y.BDY.INT.MTD.PAY = R.ACCT.REC<AC.LOCAL.REF,Y.L.AC.PAYMT.MODE.POS>
        GOSUB READ.EBL
    END

RETURN

READ.EBL:

    ID.EB = 'L.AC.PAYMT.MODE':'*':Y.BDY.INT.MTD.PAY
    CALL F.READ(FN.EB.LOOKUP,ID.EB,R.EB.LK,F.EB.LOOKUP,EB.LERR)
    Y.BDY.INT.MTD.PAY = R.EB.LK<EB.LU.DESCRIPTION,LNGG>
    IF Y.BDY.INT.MTD.PAY EQ '' THEN
        Y.BDY.INT.MTD.PAY = R.EB.LK<EB.LU.DESCRIPTION,1>
    END

RETURN

GET.CUSTOMER.NAME:
*=============

    Y.REL.CODE = R.ACC.REC<AC.RELATION.CODE>

    CALL F.READ(FN.CUSTOMER,Y.CUSTOMER.ID,R.CUSTOMER,F.CUSTOMER,Y.CUS.ERR)
    IF R.CUSTOMER<EB.CUS.LOCAL.REF,Y.L.CU.TIPO.CL.POS> EQ "PERSONA FISICA" OR R.CUSTOMER<EB.CUS.LOCAL.REF,Y.L.CU.TIPO.CL.POS> EQ "CLIENTE MENOR" THEN  ;*R22 AUTO CONVERSTION = TO EQ
        Y.CUS.NAMES = R.CUSTOMER<EB.CUS.GIVEN.NAMES>:" ":R.CUSTOMER<EB.CUS.FAMILY.NAME>
    END
    IF R.CUSTOMER<EB.CUS.LOCAL.REF,Y.L.CU.TIPO.CL.POS> EQ "PERSONA JURIDICA" THEN   ;*R22 AUTO CONVERSTION = TO EQ
        Y.CUS.NAMES = R.CUSTOMER<EB.CUS.NAME.1,1>:" ":R.CUSTOMER<EB.CUS.NAME.2,1>
    END
    IF NOT(R.CUSTOMER<EB.CUS.LOCAL.REF,Y.L.CU.TIPO.CL.POS>) THEN
        Y.CUS.NAMES = R.CUSTOMER<EB.CUS.SHORT.NAME>
    END
    Y.RELATION.COUNT = DCOUNT(Y.REL.CODE,@VM)
    Y.COUNT = 1
    LOOP
    WHILE Y.COUNT LE Y.RELATION.COUNT
        RELATION.ID = R.ACC.REC<AC.RELATION.CODE,Y.COUNT>
        IF RELATION.ID LT 500 AND RELATION.ID GT 529 THEN
            Y.COUNT += 1
        END ELSE
            GOSUB GET.CUS.NM
        END
    REPEAT
    Y.BDY.CUSTOMER.NAME = Y.CUS.NAMES
RETURN

GET.CUS.NM:

    CALL F.READ(FN.RELATION,RELATION.ID,R.RELATION,F.RELATION,Y.REL.ERR)
    Y.REL.DESC = R.RELATION<EB.REL.DESCRIPTION>
    CUSTOMER.ID = R.ACC.REC<AC.JOINT.HOLDER,Y.COUNT>
    CALL F.READ(FN.CUSTOMER,CUSTOMER.ID,R.CUSTOMER,F.CUSTOMER,Y.CUS.ERR)
    IF R.CUSTOMER<EB.CUS.LOCAL.REF,Y.L.CU.TIPO.CL.POS> EQ "PERSONA FISICA" OR R.CUSTOMER<EB.CUS.LOCAL.REF,Y.L.CU.TIPO.CL.POS> EQ "CLIENTE MENOR" THEN ;*R22 AUTO CONVERSTION = TO EQ

        Y.CUS.NAME = R.CUSTOMER<EB.CUS.GIVEN.NAMES>:" ":R.CUSTOMER<EB.CUS.FAMILY.NAME>
    END
    IF R.CUSTOMER<EB.CUS.LOCAL.REF,Y.L.CU.TIPO.CL.POS> EQ "PERSONA JURIDICA" THEN  ;*R22 AUTO CONVERSTION = TO EQ
        Y.CUS.NAME = R.CUSTOMER<EB.CUS.NAME.1,1>:" ":R.CUSTOMER<EB.CUS.NAME.2,1>
    END
    IF NOT(R.CUSTOMER<EB.CUS.LOCAL.REF,Y.L.CU.TIPO.CL.POS>) THEN
        Y.CUS.NAME = R.CUSTOMER<EB.CUS.SHORT.NAME>
    END
    Y.CUS.NAMES := @VM:Y.REL.DESC:'-':Y.CUS.NAME
    Y.CLIENT.CODE := @VM:CUSTOMER.ID
    Y.COUNT += 1

RETURN

END
